<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Stenomania Dictations | Advanced Transcription Platform</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+Devanagari:wght@400;600&display=swap" rel="stylesheet">
  <!-- Deferring scripts to improve initial page load speed -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <!-- YouTube IFrame Player API -->
  <script src="https://www.youtube.com/iframe_api"></script>

<style>
    :root {
      --bg-light: #f3f4f7;
      --card-light: #ffffff;
      --text-primary: #111827;
      --text-secondary: #4b5563;
      --primary: #2d3748; 
      --primary-hover: #1f2937;
      --primary-light: #eef2ff;
      --danger: #ef4444;
      --success: #10b981;
      --warning: #f59e0b;
      --font-family: 'Inter', sans-serif;
    }

    html { scroll-behavior: smooth; }
    body {
        font-family: var(--font-family);
        background-color: var(--bg-light);
        color: var(--text-primary);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    .btn {
        transition: all 0.2s ease-in-out;
        transform: translateY(0);
    }
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .btn:active {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    .btn-primary { background-color: var(--primary); color: white; }
    .btn-primary:hover { background-color: var(--primary-hover); }
    .btn-primary:disabled { background-color: #a5b4fc; cursor: not-allowed; transform: none; box-shadow: none; }
    .btn-secondary { background-color: var(--text-secondary); color: white; }
    .btn-secondary:hover { background-color: #2d3748; }
    
    .card {
        background-color: var(--card-light);
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
        border: 1px solid #e2e8f0;
        transition: box-shadow 0.3s ease, transform 0.3s ease;
    }
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07);
    }

    .input-field {
        background-color: #f8fafc;
        border: 1px solid #e2e8f0;
        transition: all 0.3s;
    }
    .input-field:focus, .input-field:focus-visible {
        box-shadow: 0 0 0 3px rgba(45, 55, 72, 0.2);
        border-color: var(--primary);
        outline: none;
    }
    
    .nav-link {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        font-weight: 600;
        color: var(--text-secondary);
        transition: background-color 0.2s ease, color 0.2s ease;
    }
    .nav-link:hover {
        background-color: #e5e7eb;
        color: var(--text-primary);
    }
    .nav-link.active {
        background-color: var(--primary);
        color: white;
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
    }
    .nav-link i {
        width: 1.25rem;
        margin-right: 0.75rem;
        text-align: center;
    }
    #sidebar {
      transition: transform 0.3s ease-in-out;
    }

    /* Comparison Text Styles */
    .correct { color: #16a34a; font-weight: 500; }
    .missing { color: var(--danger); font-weight: 600; background-color: rgba(239, 68, 68, 0.1); padding: 1px 4px; border-radius: 4px;}
    .addition { color: #2563eb; font-weight: 600; background-color: rgba(59, 130, 246, 0.1); padding: 1px 4px; border-radius: 4px; text-decoration: line-through;}
    .capitalization { color: #9333ea; font-weight: 600; border-bottom: 2px dotted #9333ea; }
    .punctuation { color: var(--warning); font-weight: 600; background-color: rgba(245, 158, 11, 0.1); padding: 1px 4px; border-radius: 4px;}

    .spelling-mistake-wrapper { color: var(--danger); background-color: rgba(239, 68, 68, 0.1); padding: 1px 5px; border-radius: 4px; font-weight: 500; }
    .spelling-mistake-wrapper .incorrect-word { text-decoration: line-through; opacity: 0.8; }
    .spelling-mistake-wrapper .correct-word-suggestion { font-weight: 600; }
    .explainable-word { cursor: pointer; transition: background-color 0.2s; border-radius: 3px; }
    .explainable-word:hover { background-color: rgba(45, 55, 72, 0.1); }
    .mistake-word-container { position: relative; display: inline-block; }
    .add-to-practice-btn { position: absolute; top: -5px; right: -5px; background-color: var(--success); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; border: 1px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); cursor: pointer; opacity: 0; transform: scale(0.8); transition: opacity 0.2s ease, transform 0.2s ease; z-index: 10; }
    .touch-disabled .mistake-word-container:hover .add-to-practice-btn { opacity: 1; transform: scale(1); }
    .add-to-practice-btn:hover { transform: scale(1.15); }
    .add-to-practice-btn:disabled { background-color: #10b981; opacity: 0.7; cursor: not-allowed; color: white; }
    .add-to-practice-btn .fa-check-circle { color: white; }
    .mistake-word-container .add-to-practice-btn { display: inline-flex; }
    .touch-enabled .mistake-word-container .add-to-practice-btn { display: none; }
    #wordActionPopover { transition: opacity 0.1s ease-in-out, transform 0.1s ease-in-out; }
    #toast-container { position: fixed; top: 1.5rem; right: 1.5rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.75rem; }
    .toast { display: flex; align-items: center; padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); transform: translateX(120%); animation: slideIn 0.5s forwards, fadeOut 0.5s 4.5s forwards; }
    .toast-success { background: linear-gradient(to right, #10b981, #059669); }
    .toast-error { background: linear-gradient(to right, #ef4444, #dc2626); }
    .toast-info { background: linear-gradient(to right, #3b82f6, #2563eb); }
    .toast i { margin-right: 0.75rem; font-size: 1.25rem; }
    @keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; transform: translateX(120%); } }
    #practiceTextDisplay .word { display: inline-block; margin: 0 5px 10px 0; font-size: 1.75rem; letter-spacing: 1px; padding: 2px 4px; }
    #practiceTextDisplay .word.current { background-color: var(--primary-light); border-radius: 4px; }
    #practiceTextDisplay .letter { transition: color 0.2s; }
    .letter.correct { color: var(--success); }
    .letter.incorrect { color: var(--danger); }
    .word.completed-correct { color: var(--success); }
    .word.completed-incorrect { color: var(--danger); text-decoration: underline; text-decoration-thickness: 2px; }
    #videoContainer { position: relative; width: 100%; padding-top: 56.25%; background-color: #fff; border-radius: 0.5rem; overflow: hidden; }
    #videoContainer > #youtube-player-div { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    
    .dictation-mode-hidden {
        position: absolute;
        top: -9999px;
        left: -9999px;
        width: 1px;
        height: 1px;
        overflow: hidden;
        padding-top: 0; 
    }

    #explainModal { z-index: 9999; }
    #explainModalContent .grid h5 { font-family: var(--font-family); }
    #explainModalContent .grid p[lang="hi"] { font-family: 'Inter', 'Noto Sans Devanagari', sans-serif; font-size: 1.1rem; }
    .info-section { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0; }
    .info-section h5 { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary); margin-bottom: 0.5rem; }
    .info-chip { display: inline-block; background-color: #eef2ff; color: var(--primary); padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 500; margin-right: 0.5rem; margin-bottom: 0.5rem; }
    .rule-section { background-color: #f7f9fc; border-left: 4px solid var(--primary); padding: 0.75rem 1rem; margin-top: 1rem; border-radius: 0.25rem; }
    .rule-section h5 { display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: var(--primary); text-transform: none; letter-spacing: normal; font-size: 1rem; }
    @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes bounceIn { 0% { opacity: 0; transform: scale(0.5); } 80% { opacity: 1; transform: scale(1.05); } 100% { transform: scale(1); } }
    .animate-fade-in-down { animation: fadeInDown 0.6s ease-out forwards; }
    .animate-fade-in-up { animation: fadeInUp 0.6s ease-out forwards; }
    .animate-bounce-in { animation: bounceIn 0.6s cubic-bezier(0.215, 0.61, 0.355, 1) forwards; }
    .delay-100 { animation-delay: 100ms; } .delay-200 { animation-delay: 200ms; } .delay-300 { animation-delay: 300ms; } .delay-400 { animation-delay: 400ms; }
    .audio-player-wrapper { border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem; background-color: #f8fafc; }
    audio { display: none; }
    .progress-bar { height: 8px; background-color: #e2e8f0; border-radius: 4px; overflow: hidden; }
    .progress-bar-inner { height: 100%; width: 0%; background-color: var(--primary); transition: width 0.3s ease; }
    #audioSeekSlider, #videoSeekSlider, .solution-seek-slider { -webkit-appearance: none; width: 100%; height: 8px; background: #eef2ff; border-radius: 5px; outline: none; transition: opacity .2s; }
    #audioSeekSlider::-webkit-slider-thumb, #videoSeekSlider::-webkit-slider-thumb, .solution-seek-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: var(--primary); cursor: pointer; border-radius: 50%; border: 3px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    #audioSeekSlider::-moz-range-thumb, #videoSeekSlider::-moz-range-thumb, .solution-seek-slider::-moz-range-thumb { width: 20px; height: 20px; background: var(--primary); cursor: pointer; border-radius: 50%; border: 3px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    .pass-details-grid { display: grid; grid-template-columns: auto 1fr; gap: 0.75rem 1.5rem; align-items: center; }
    .pass-details-grid dt { font-weight: 600; color: var(--text-secondary); }
    .pass-details-grid dd { font-weight: 500; color: var(--text-primary); }
    .progress-ring { position: relative; width: 150px; height: 150px; }
    .progress-ring__circle { transition: stroke-dashoffset 0.8s ease-out; transform: rotate(-90deg); transform-origin: 50% 50%; }
    .progress-ring__text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
    .progress-ring__days { font-size: 3rem; font-weight: 800; line-height: 1; color: var(--text-primary); }
    .progress-ring__label { font-size: 1rem; color: var(--text-secondary); }

    /* --- Password Strength Indicator Styles --- */
    #passwordStrengthIndicator ul { list-style-type: none; padding: 0; }
    #passwordStrengthIndicator li {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        transition: color 0.3s ease;
    }
    #passwordStrengthIndicator li.invalid { color: var(--text-secondary); }
    #passwordStrengthIndicator li.invalid i { color: var(--danger); }
    #passwordStrengthIndicator li.valid { color: var(--success); font-weight: 500; }
    #passwordStrengthIndicator li.valid i { color: var(--success); }
</style>
</head>
<body class="text-gray-800">
  
  <div id="toast-container"></div>

  <div class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-50">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-20">
          <div class="flex items-center space-x-4">
             <!-- Mobile Menu Button -->
             <button id="mobileMenuBtn" class="lg:hidden text-gray-600 hover:text-gray-900">
                <i class="fas fa-bars fa-lg"></i>
            </button>
            <a href="#" id="homeLink" class="text-2xl font-extrabold text-gray-900">
                Stenomania Dictations 
            </a>
          </div>
          <div id="authSection" class="flex items-center space-x-2 sm:space-x-4">
              <button id="loginBtn" class="btn btn-primary px-4 py-2 rounded-md font-semibold text-base">Welcome</button>
              <div id="userInfo" class="hidden flex items-center space-x-4">
                  <span id="passExpiryInfo" class="hidden text-xs font-semibold bg-green-100 text-green-800 px-3 py-1.5 rounded-full"></span>
                  
                  <!-- User Dropdown Menu -->
                  <div class="relative">
                       <button id="userMenuBtn" class="flex items-center space-x-2 focus:outline-none">
                          <img id="userPhoto" class="w-10 h-10 rounded-full object-cover border-2 border-gray-200">
                          <span id="userName" class="font-semibold hidden sm:inline"></span>
                          <i class="fas fa-chevron-down text-xs text-gray-500"></i>
                       </button>
                       <div id="userDropdown" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-md shadow-lg py-1 z-50 border border-gray-200">
                           <a href="#" id="myProfileBtn" class="block lg:hidden px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"><i class="fas fa-user-circle w-5 mr-2"></i>My Profile</a>
                           <a href="#" id="myProgressBtn" class="block lg:hidden px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"><i class="fas fa-chart-line w-5 mr-2"></i>Dashboard</a>
                           <a href="#" id="yourStenoBtn" class="block lg:hidden px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"><i class="fas fa-keyboard w-5 mr-2"></i>Your Steno</a>
                           <a href="#" id="adminBtn" class="hidden block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"><i class="fas fa-user-shield w-5 mr-2"></i>Admin Panel</a>
                           <a href="#" id="leaderboardBtn" class="hidden block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"><i class="fas fa-trophy w-5 mr-2"></i>Leaderboard</a>
                           <div class="border-t my-1 border-gray-100"></div>
                           <a href="#" id="logoutBtn" class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50"><i class="fas fa-sign-out-alt w-5 mr-2"></i>Logout</a>
                       </div>
                  </div>
              </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Page container for sidebar and main content -->
    <div id="pageContainer" class="flex flex-1">
        <!-- Sidebar Navigation (visible on large screens) -->
        <aside id="sidebar" class="w-64 bg-white flex-shrink-0 p-4 border-r border-gray-200 shadow-sm hidden lg:flex flex-col">
            <!-- Logged In State -->
            <div id="sidebarLoggedInState" class="hidden">
                <div class="mb-6 p-3">
                    <h2 id="sidebarUserName" class="text-lg font-bold text-gray-800">Hi, User</h2>
                    <a href="#" id="sidebarLogoutBtn" class="text-sm text-red-600 hover:underline">Logout</a>
                </div>
            </div>
            <!-- Logged Out State -->
            <div id="sidebarLoggedOutState" class="hidden">
                 <div class="mb-6 p-3">
                    <button id="sidebarLoginBtn" class="btn btn-primary w-full py-2.5 rounded-lg font-bold">Login / Register</button>
                </div>
            </div>

            <nav class="space-y-2 flex-grow">
                <a href="#" id="sidebarHomeBtn" class="nav-link active"><i class="fas fa-home"></i> Home</a>
                <a href="#" id="sidebarProfileBtn" class="nav-link"><i class="fas fa-user-circle"></i> My Profile</a>
                <a href="#" id="sidebarDashboardBtn" class="nav-link"><i class="fas fa-chart-line"></i> Dashboard</a>
                <a href="#" id="sidebarPassBtn" class="nav-link"><i class="fas fa-ticket-alt"></i> Pass</a>
                <a href="#" id="sidebarLeaderboardBtn" class="nav-link hidden"><i class="fas fa-trophy"></i> Leaderboard</a>
                <a href="#" id="sidebarStenoBtn" class="nav-link"><i class="fas fa-keyboard"></i> Your Steno</a>
                <a href="#" id="sidebarAdminBtn" class="nav-link hidden"><i class="fas fa-user-shield"></i> Admin Panel</a>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <div class="flex-grow w-full overflow-y-auto">
            <main class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">
                <!-- Login Prompt -->
                <section id="loginPrompt" class="max-w-md mx-auto mt-10 card rounded-lg shadow-xl p-8">
                    <div id="loginForm">
                        <h3 class="text-2xl font-bold text-center mb-6 text-gray-800">Login to Stenomania Dictation</h3>
                        <div class="space-y-4">
                            <input type="email" id="loginEmail" placeholder="Email" class="w-full p-3 rounded-md input-field">
                            <input type="password" id="loginPassword" placeholder="Password" class="w-full p-3 rounded-md input-field">
                            <button id="emailLoginBtn" class="w-full btn btn-primary py-3 rounded-md font-bold text-lg">Login</button>
                            <button id="googleLoginBtn" class="w-full btn bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 py-3 rounded-md font-bold text-lg flex items-center justify-center space-x-2"><i class="fab fa-google text-red-500"></i><span>Login with Google</span></button>
                        </div>
                        <div class="text-center mt-4">
                            <a href="#" id="showForgotPassword" class="text-sm text-gray-600 hover:text-gray-800 hover:underline">Forgot Password?</a>
                        </div>
                        <p class="text-center mt-6">Don't have an account? <a href="#" id="showRegister" class="text-gray-800 font-semibold hover:underline">Register</a></p>
                    </div>
                    <div id="registerForm" class="hidden">
                        <h3 class="text-2xl font-bold text-center mb-6 text-gray-800">Create an Account</h3>
                        <div class="space-y-4">
                            <input type="text" id="registerName" placeholder="Full Name" class="w-full p-3 rounded-md input-field">
                            <input type="email" id="registerEmail" placeholder="Email" class="w-full p-3 rounded-md input-field">
                            <div>
                                <input type="password" id="registerPassword" placeholder="Password" class="w-full p-3 rounded-md input-field">
                                <div id="passwordStrengthIndicator" class="hidden mt-2 p-3 bg-gray-50 rounded-md border">
                                    <ul class="space-y-1">
                                        <li id="strength-length" class="invalid"><i class="fas fa-times"></i> At least 8 characters</li>
                                        <li id="strength-lowercase" class="invalid"><i class="fas fa-times"></i> At least one lowercase letter</li>
                                        <li id="strength-uppercase" class="invalid"><i class="fas fa-times"></i> At least one uppercase letter</li>
                                        <li id="strength-number" class="invalid"><i class="fas fa-times"></i> At least one number</li>
                                    </ul>
                                    <!-- NEW: Password example hint -->
                                    <p class="text-xs text-gray-500 mt-2 text-center">Example: <strong>Ram@1234</strong></p>
                                </div>
                            </div>
                            <input type="password" id="confirmPassword" placeholder="Confirm Password" class="w-full p-3 rounded-md input-field">
                            <button id="registerBtn" class="w-full btn btn-primary py-3 rounded-md font-bold text-lg">Register</button>
                        </div>
                        <p class="text-center mt-6">Already have an account? <a href="#" id="showLogin" class="text-gray-800 font-semibold hover:underline">Back to Login</a></p>
                    </div>
                    <!-- NEW: Forgot Password Form -->
                    <div id="forgotPasswordForm" class="hidden">
                        <h3 class="text-2xl font-bold text-center mb-6 text-gray-800">Reset Your Password</h3>
                        <p class="text-center text-gray-600 mb-6">Enter your email address below, and we'll send you a link to reset your password. If you don't see the email in your inbox, please check your spam or junk folder.</p>
                        <div class="space-y-4">
                            <input type="email" id="resetEmail" placeholder="Enter your registered email" class="w-full p-3 rounded-md input-field">
                            <button id="sendResetLinkBtn" class="w-full btn btn-primary py-3 rounded-md font-bold text-lg">Send Reset Link</button>
                        </div>
                        <p class="text-center mt-6"><a href="#" id="backToLoginFromForgot" class="text-gray-800 font-semibold hover:underline">Back to Login</a></p>
                    </div>
                </section>
                
                <!-- Activation Prompt -->
                <section id="activationPrompt" class="hidden max-w-lg mx-auto mt-10 card rounded-lg shadow-xl p-8">
                      <h2 class="text-2xl font-bold text-center mb-4 text-gray-800">Activate Your Test Pass</h2>
                      <p class="text-center text-gray-600 mb-6">Enter the activation code you received to unlock the tests. </p>
<p style="font-size: 15px; color: #555; margin-top: 10px;">
    If you already have an active pass, click below to access it:
  </p>
  <a href="app.html" 
     style="display: inline-block; margin: 10px 0; padding: 10px 20px; font-size: 16px; font-weight: bold; color: white; background: #28a745; border-radius: 8px; text-decoration: none;">
    Access Active Test
  </a>
                      <div class="space-y-4">
                          <input type="text" id="activationCodeInput" placeholder="Enter Activation Code" class="w-full p-3 rounded-md input-field text-center tracking-widest font-mono uppercase">
                          <button id="activatePassBtn" class="w-full btn btn-primary py-3 rounded-md font-bold text-lg">Activate</button>
                      </div>
                      <p style="font-size: 15px; color: #555; margin-top: 15px;">
    To purchase a pass code, please click below:
  </p>
  <a href="index.html" target="_blank" style="display: inline-block; margin-top: 10px; padding: 10px 20px; font-size: 16px; font-weight: bold; color: white; background: #007bff; border-radius: 8px; text-decoration: none;">
    Buy Now
  </a>
                </section>

                <!-- App Content -->
                <div id="appContent" class="hidden">
                  <div id="main-view">
                      <div class="max-w-7xl mx-auto w-full space-y-8">
                          <!-- Test Selection UI -->
                          <section id="newTestSelectionUI" class="w-full">
                              <section id="aiFeatureBanner" class="w-full bg-gradient-to-r from-purple-600 to-indigo-700 text-white rounded-xl shadow-lg p-8 text-center relative overflow-hidden mb-12">
                                <div class="absolute inset-0 opacity-10" style="background-image: url('data:image/svg+xml,%3Csvg width=%2260%22 height=%2260%22 viewBox=%220 0 60 60%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cg fill=%22none%22 fill-rule=%22evenodd%22%3E%3Cg fill=%22%23ffffff%22 fill-opacity=%220.4%22%3E%3Cpath d=%22M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z%22/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');"></div>
                                <div class="relative z-10">
                                    <h2 class="text-4xl font-extrabold mb-3 animate-fade-in-down">ðŸ§  Practice Smarter with AI!</h2>
                                    <p class="text-lg mb-6 max-w-3xl mx-auto animate-fade-in-up delay-100">Get instant definitions, phonetics, synonyms, and antonyms for any word. Just click a word in your results to learn more.</p>
                                    <hr class="border-white/20 my-6 max-w-xl mx-auto animate-fade-in-up delay-200">
                                    <div class="animate-fade-in-up delay-300">
                                        <h3 class="font-bold text-2xl mb-4 text-yellow-300">Enhance Your Vocabulary</h3>
                                        <div class="flex flex-col md:flex-row justify-center items-center gap-6 text-base">
                                            <div class="flex items-center gap-3"><i class="fas fa-spell-check fa-2x text-yellow-400"></i><span>Detailed Word Meanings</span></div>
                                            <div class="flex items-center gap-3"><i class="fas fa-volume-up fa-2x text-yellow-400"></i><span>Audio Pronunciations</span></div>
                                        </div>
                                    </div>
                                    <button id="ctaAiBannerBtn" class="mt-8 btn bg-yellow-400 text-purple-900 px-8 py-3 rounded-full font-bold text-lg shadow-lg hover:bg-yellow-300 transform hover:scale-105 transition-all duration-300 animate-bounce-in delay-400">âœ¨ Explore Dictations!</button>
                                </div>
                              </section>
                              <!-- Category Selection -->
                              <div id="categorySelectionView">
                                  <div class="text-center mb-12"><h2 class="text-4xl font-extrabold text-gray-900 sm:text-5xl">Choose Your Dictation Series</h2><p class="mt-4 text-lg text-gray-500 max-w-2xl mx-auto">Select a series below to view all available dictation tests, each designed to sharpen your skills.</p></div>
                                  <div id="categoryGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
                              </div>
                              <!-- Test List -->
                              <div id="testListView" class="hidden">
                                  <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4"><h2 id="testListTitle" class="text-3xl font-bold text-gray-900">Category Tests</h2><button id="backToCategoriesBtn" class="btn btn-secondary px-4 py-2 rounded-md font-semibold w-full sm:w-auto"><i class="fas fa-arrow-left mr-2"></i>Back to Series</button></div>
                                  <div class="mb-6"><input type="search" id="testListSearchInput" placeholder="Search for dictation in this series..." class="w-full max-w-lg mx-auto block p-3 rounded-md input-field"></div>
                                  <div id="testListGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"></div>
                              </div>
                          </section>
                           <!-- Transcription Area -->
                          <section id="mainInputSection" class="hidden card rounded-lg shadow-lg p-4 sm:p-6 space-y-6">
                              <div id="manualModeHeader" class="hidden flex flex-col sm:flex-row justify-between items-center pb-4 border-b border-gray-200 gap-4"><h3 class="text-xl font-bold text-gray-800 text-center sm:text-left">Manual Transcription Practice</h3><button id="backToSeriesFromManualBtn" class="btn btn-primary px-4 py-2 rounded-md font-semibold w-full sm:w-auto"><i class="fas fa-list-ul mr-2"></i> Choose Dictation Series</button></div>
                              <div id="testActionHeader" class="hidden flex flex-col sm:flex-row justify-between items-center pb-4 border-b border-gray-200 gap-4"><h3 id="selectedTestTitle" class="text-xl font-bold text-gray-800 text-center sm:text-left">Selected Test Title</h3><button id="chooseAnotherTestBtn" class="btn btn-secondary px-4 py-2 rounded-md font-semibold w-full sm:w-auto"><i class="fas fa-list-ul mr-2"></i> Choose Another Test</button></div>
                              <div class="input-group" id="originalTextGroup"><textarea id="originalText" placeholder="Paste original text here or select a test above" spellcheck="false" autocorrect="off" class="w-full p-4 rounded-md input-field h-32"></textarea></div>
                              <div id="videoContainer" class="hidden"></div>
                              <div id="audioPlayerContainer" class="hidden audio-player-wrapper"></div>
                              <div id="dictationControlContainer" class="hidden flex flex-wrap justify-center items-center gap-4 mt-4 p-4 bg-gray-50 rounded-lg border">
                                  <button id="playDictationBtn" class="btn btn-primary px-6 py-2 rounded-md font-semibold text-lg"><i class="fas fa-play mr-2"></i>Play Dictation</button>
                                  <div class="flex items-center gap-2 border-l pl-4 ml-2"><label for="dictationSpeedWPM" class="text-sm font-semibold text-gray-700">Target WPM:</label><select id="dictationSpeedWPM" class="p-2 rounded-md input-field bg-white"><option value="original">Original</option><option value="60">60</option><option value="65">65</option><option value="70">70</option><option value="75">75</option><option value="80" selected>80</option><option value="85">85</option><option value="90">90</option><option value="95">95</option><option value="100">100</option><option value="105">105</option><option value="110">110</option><option value="115">115</option><option value="120">120</option><option value="130">130</option><option value="140">140</option><option value="150">150</option><option value="160">160</option></select></div>
                                  <!-- NEW: Fluctuation Level -->
                                  <div class="flex items-center gap-2 border-l pl-4 ml-2">
                                      <label for="fluctuationLevel" class="text-sm font-semibold text-gray-700">Fluctuation Level</label>
                                      <i class="fas fa-info-circle text-gray-400 cursor-pointer" title="Simulates real-world speed variations around the target WPM."></i>
                                      <select id="fluctuationLevel" class="p-2 rounded-md input-field bg-white">
                                          <option value="0" selected>Off</option>
                                          <option value="0.05">Low (Â±5%)</option>
                                          <option value="0.10">Medium (Â±10%)</option>
                                          <option value="0.15">High (Â±15%)</option>
                                      </select>
                                  </div>
                                  <!-- NEW: Practice Length Controls -->
                                  <div class="flex items-center gap-2 border-l pl-4 ml-2">
                                    <label for="dictationLengthSelector" class="text-sm font-semibold text-gray-700">Practice:</label>
                                    <select id="dictationLengthSelector" class="p-2 rounded-md input-field bg-white">
                                        <option value="full" selected>Full Length</option>
                                    </select>
                                    <span id="totalWordsDisplay" class="text-sm text-gray-600 font-mono"></span>
                                  </div>
                              </div>
                              <button id="startTranscriptionBtn" class="hidden mt-4 w-full btn btn-primary py-3 rounded-md font-bold text-lg"><i class="fas fa-keyboard mr-2"></i>Start Transcription</button>
                              <div id="timerDisplay" class="hidden text-center text-4xl font-bold text-red-500"></div>
                              <textarea id="userText" placeholder="Your transcription will appear here..." readonly spellcheck="false" autocorrect="off" class="w-full p-4 rounded-md input-field h-64 bg-gray-200 cursor-not-allowed hidden"></textarea>
                              <button id="compareBtn" class="hidden mt-4 w-full btn btn-primary py-3 rounded-md font-bold text-lg"><i class="fas fa-check-double mr-2"></i>Compare Texts</button>
                          </section>
                      </div>
                  </div>
                  <!-- Placeholder Sections -->
                  <section id="userProfileSection" class="hidden"></section>
                  <section id="leaderboardSection" class="hidden"></section>
                  <section id="progressSection" class="hidden"></section>
                  <section id="adminSection" class="hidden"></section>
                  <section id="examInterface" class="hidden"></section>
                </div>
            </main>

            <!-- Footer -->
            <footer class="bg-indigo-900 text-white py-12">
              <div class="container mx-auto px-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                  <!-- Contact Column -->
                  <div>
                    <h4 class="text-lg font-bold mb-4">Contact</h4>
                    <div class="space-y-2 text-gray-200">
                      <p>
                        <strong>Telegram Support:</strong> t.me/stenomaniadictation
                      </p>
                      
                      
                    </div>
                  </div>
                  
                  <!-- Quick Links Column -->
                  <div>
                    <h4 class="text-lg font-bold mb-4">Quick Links</h4>
                    <ul class="space-y-2">
                      <li><a href="terms.html" class="text-gray-200 hover:text-white transition">Terms & Conditions</a></li>
                      <li><a href="privacy" class="text-gray-200 hover:text-white transition">Privacy Policy</a></li>
                      
                    </ul>
                  </div>
            
                  <!-- Follow Us Column -->
                  <div>
                    <h4 class="text-lg font-bold mb-4">Follow Us</h4>
                    <div class="flex space-x-4">
                      <a href="https://t.me/stenomaniadictation" class="w-10 h-10 rounded-full bg-red-600 flex items-center justify-center text-white hover:bg-red-700 transition text-xl" aria-label="Telegram">
                        <i class="fab fa-telegram-plane"></i>
                      </a>
                      <a href="#" class="w-10 h-10 rounded-full bg-red-600 flex items-center justify-center text-white hover:bg-red-700 transition text-xl" aria-label="YouTube">
                        <i class="fab fa-youtube"></i>
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            </footer>
        </div>
    </div>
  </div>

  <!-- These modals and popovers remain outside the main structure for correct z-index stacking -->
  <section id="results" class="hidden fixed inset-0 bg-gray-100 z-[100] overflow-y-auto p-4 sm:p-6 lg:p-8">
    <div class="max-w-4xl mx-auto">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4"><h2 class="text-3xl font-bold text-gray-800">Your Results</h2><div id="resultTimestamp" class="text-sm text-gray-500"></div><div class="flex gap-4"><button id="downloadPdfBtn" class="btn bg-green-500 text-white px-4 py-2 rounded-md"><i class="fas fa-file-pdf mr-2"></i>PDF</button><button id="closeResultsBtnTop" class="btn bg-gray-500 text-white px-4 py-2 rounded-md"><i class="fas fa-times mr-2"></i>Close</button></div></div>
        <div id="stats" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"></div>
        <div id="moreStats" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"></div>
        
        <!-- NEW: Applied Rules Container -->
        <div id="appliedRulesContainer" class="hidden bg-white rounded-lg shadow p-3 text-center mb-6">
            <p class="text-sm text-gray-700">
                <strong>Applied Rules:</strong> 
                <span id="appliedRulesText" class="font-normal text-gray-600"></span>
            </p>
        </div>

        <div id="audioSolutionContainer" class="card rounded-lg shadow p-4 sm:p-6 mb-6 hidden">
            <h3 class="text-xl font-bold mb-4 text-green-600"><i class="fas fa-file-audio mr-2"></i>Audio Solution</h3>
            <div id="audioSolutionPlayer" class="audio-player-wrapper"></div>
        </div>
        
        <div id="videoSolutionContainer" class="card rounded-lg shadow p-4 sm:p-6 mb-6 hidden">
            <!-- This container will be populated by JavaScript -->
        </div>

        <div class="card rounded-lg shadow p-4 sm:p-6 mb-6">
            <h3 class="text-xl font-bold mb-4">Stenomania Dictations<span id="resultModeTag" class="ml-2 text-base font-semibold text-purple-700"></span></h3>
            <div class="flex flex-wrap gap-x-6 gap-y-2 mb-4 text-sm"><span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-green-500"></span> Correct</span><span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-red-500"></span> Omission</span><span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full" style="background-color: #fca5a5;"></span> Spelling</span><span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-blue-500"></span> Addition</span><span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-purple-500"></span> Capitalization</span><span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-yellow-500"></span> Punctuation</span></div>
            <div class="mb-4 bg-indigo-50 border-l-4 border-indigo-400 p-4 rounded-r-lg"><div class="flex"><div class="flex-shrink-0"><i class="fas fa-lightbulb text-indigo-500 fa-lg"></i></div><div class="ml-3"><p class="text-sm font-semibold text-indigo-700">Learning Tip: Spelling mistakes show your typo <s class="font-bold">crossed out</s> next to the correct word. Click any word to get a detailed explanation!</p></div></div></div>
            <div id="comparisonResult" class="text-lg leading-relaxed p-4 bg-gray-50 rounded-md border border-gray-200"></div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div id="feedback" class="card rounded-lg shadow p-4 sm:p-6"></div><div class="card rounded-lg shadow p-4 sm:p-6"><h3 class="text-xl font-bold mb-4">Full Texts</h3><div class="space-y-4"><div><h4 class="font-semibold mb-2">Original Text</h4><div id="originalDisplay" class="text-sm max-h-48 overflow-y-auto p-3 bg-gray-50 rounded border"></div></div><div><h4 class="font-semibold mb-2">Your Transcription</h4><div id="userDisplay" class="text-sm max-h-48 overflow-y-auto p-3 bg-gray-50 rounded border"></div></div></div></div></div>
        <div class="mt-8 space-y-6"><div class="bg-blue-50 border-l-4 border-blue-500 text-blue-800 p-4 rounded-r-lg"><h3 class="font-bold text-lg"><i class="fas fa-info-circle mr-2"></i>A Quick Note</h3><p class="mt-2">Please donâ€™t worry about small things like <strong>date formats</strong>, <strong>brackets</strong>, <strong>short forms</strong>, or words like <em>hon</em>, <em>Honâ€™ble</em>, or <em>Ramâ€™s</em>. The software counts all mistakes as <strong>full mistakes</strong>, even if they are minor.</p></div><div class="bg-red-50 border-l-4 border-red-500 text-red-800 p-4 rounded-r-lg"><h3 class="font-bold text-lg"><i class="fas fa-exclamation-triangle mr-2"></i>Most Important</h3><p class="mt-2">If your result isnâ€™t what you expected, <strong class="font-semibold">donâ€™t get discouraged</strong> and <strong class="font-semibold">never think of giving up</strong>. A true winner <strong>never quits</strong>. Instead, analyze your mistakes, learn from them, and keep practicing. If you see any software-related errors that donâ€™t make sense, try to ignore them and focus on <strong>your real progress</strong>.</p></div><p class="text-lg font-bold text-center text-green-700 mt-6">ðŸ’ª Do your best â€” because your best efforts today will create your best future! ðŸŒŸ</p></div>
    </div>
  </section>

  <div id="wordActionPopover" class="hidden absolute z-[150] bg-white rounded-md shadow-lg border border-gray-200 p-2 flex gap-2 text-sm"><button id="popoverAddBtn" class="btn bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-md font-semibold"><i class="fas fa-plus-circle mr-1.5"></i> Add to Practice</button><button id="popoverExplainBtn" class="btn bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1 rounded-md font-semibold"><i class="fas fa-book-open mr-1.5"></i> Define</button></div>
  <section id="typingPracticeModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-[110] flex items-center justify-center p-4"><div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col p-6"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold text-gray-800">Mistake Typing Practice</h2><button id="closePracticeModalBtn" class="text-gray-400 hover:text-red-600 text-3xl">&times;</button></div><div id="practiceSetupView" class="flex-grow flex flex-col min-h-0"><div class="mb-4"><label for="manualAddWordInput" class="block text-sm font-medium text-gray-700 mb-1">Manually Add Words</label><div class="flex gap-2"><input type="text" id="manualAddWordInput" placeholder="Type words, separated by space or comma" class="w-full p-2 rounded-md input-field"><button id="manualAddWordBtn" class="btn btn-primary px-4 rounded-md font-semibold">Add</button></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center mb-4"><div class="flex items-center gap-2"><label for="repetitionCountInput" class="text-sm font-medium text-gray-700">Repeat each word:</label><input type="number" id="repetitionCountInput" value="5" min="1" max="20" class="w-20 p-2 rounded-md input-field text-center"><span class="text-sm text-gray-600">times</span></div><button id="startPracticeSessionBtn" class="w-full btn btn-primary py-3 rounded-md font-bold text-lg"><i class="fas fa-play-circle mr-2"></i>Start Typing Practice (<span id="repetitionCountDisplay">5</span>x)</button></div><div class="flex justify-between items-baseline mb-2"><h3 class="text-lg font-semibold">Your Practice Word List:</h3><div><button id="printPracticeWordsBtn" class="btn bg-green-500 text-white px-3 py-1 text-sm rounded-md mr-2" disabled><i class="fas fa-print mr-1"></i> Print</button><button id="clearPracticeListBtn" class="btn bg-red-500 text-white px-3 py-1 text-sm rounded-md">Clear All</button></div></div><div id="practiceWordChipContainer" class="flex-grow min-h-0 bg-gray-100 p-3 rounded-md overflow-y-auto border"><div id="practiceWordChipInner" class="flex flex-wrap gap-2"></div></div></div><div id="practiceSessionView" class="hidden flex-grow flex flex-col gap-4"><p class="text-sm text-gray-600">Type the highlighted word. Press <kbd class="px-2 py-1.5 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-lg">Space</kbd> to move to the next word.</p><div id="practiceTextDisplay" class="p-4 bg-gray-50 border rounded-md h-48 overflow-y-auto leading-relaxed"></div><input id="practiceTextInput" class="w-full p-4 rounded-md input-field text-2xl font-mono" placeholder="Start typing here..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" /><button id="backToPracticeSetupBtn" class="btn btn-secondary py-2 rounded-md font-semibold"><i class="fas fa-arrow-left mr-2"></i>Back to Word List</button></div></div></section>
  <div id="explainModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[120] flex items-center justify-center p-4"><div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col"><div class="flex justify-between items-center p-4 border-b"><h3 class="text-lg font-bold text-gray-800">AI Dictionary</h3><button id="closeExplainModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button></div><div id="explainModalContent" class="p-6 overflow-y-auto flex-grow"></div><div class="p-4 border-t bg-gray-50 flex justify-end"><button id="closeExplainModalBtn" class="btn btn-primary px-4 py-2">Close</button></div></div></div>

  <!-- NEW: Rank Modal -->
  <div id="rankModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-[120] flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-sm animate-bounce-in">
        <div class="flex justify-between items-center p-4 border-b">
            <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                <i class="fas fa-trophy text-yellow-500"></i> Your Rank for this Dictation
            </h3>
            <button id="closeRankModal" class="text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div id="rankModalContent" class="p-8 text-center">
            <!-- Content will be populated by JS -->
        </div>
    </div>
  </div>

  <!-- NEW: Configure Session Modal -->
  <section id="configureSessionModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-[110] flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
      <h2 class="text-2xl font-bold text-center mb-2">Configure Your Transcription Session</h2>
      <p class="text-center text-gray-500 mb-6">Set your error-checking style: Manual or Exam Based.</p>
      
      <!-- Tabs -->
      <div class="flex border-b mb-6">
        <button id="configTabManual" class="px-6 py-2 font-semibold text-indigo-600 border-b-2 border-indigo-600">Manual</button>
        <button id="configTabExam" class="px-6 py-2 font-semibold text-gray-500">By Exam</button>
      </div>

      <!-- Manual Tab Content -->
      <div id="configContentManual">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="configBackspace" class="block text-sm font-medium text-gray-700">Backspace Status</label>
            <select id="configBackspace" class="w-full p-2 mt-1 rounded-md input-field">
              <option value="enabled" selected>Enabled</option>
              <option value="disabled">Disabled</option>
            </select>
          </div>
          <div>
            <label for="configSpelling" class="block text-sm font-medium text-gray-700">Count Spelling Mistake as</label>
            <select id="configSpelling" class="w-full p-2 mt-1 rounded-md input-field">
              <option value="0.5">Half</option>
              <option value="1" selected>Full</option>
              <option value="0">None</option>
            </select>
          </div>
          <div>
            <label for="configCapitalization" class="block text-sm font-medium text-gray-700">Count Capitalization Mistake as</label>
            <select id="configCapitalization" class="w-full p-2 mt-1 rounded-md input-field">
              <option value="0">None</option>
              <option value="0.5">Half</option>
              <option value="1" selected>Full</option>
            </select>
          </div>
          <div>
            <label for="configPunctuation" class="block text-sm font-medium text-gray-700">Count Punctuation Mistake as</label>
            <select id="configPunctuation" class="w-full p-2 mt-1 rounded-md input-field">
              <option value="0">None</option>
              <option value="0.5">Half</option>
              <option value="1" selected>Full</option>
            </select>
          </div>
          <div class="md:col-span-2">
             <label for="configTime" class="block text-sm font-medium text-gray-700">Transcription Time</label>
             <select id="configTime" class="w-full p-2 mt-1 rounded-md input-field">
               <option value="40">40 Minutes</option>
               <option value="50" selected>50 Minutes</option>
               <option value="60">60 Minutes</option>
               <option value="custom">Custom</option>
             </select>
             <div id="configCustomTimeContainer" class="hidden mt-2 flex items-center gap-2">
               <input type="number" id="configCustomTimeInput" placeholder="Mins" min="1" max="180" class="w-24 p-2 rounded-md input-field text-center">
             </div>
          </div>
        </div>
      </div>

      <!-- Exam Tab Content (Placeholder) -->
      <div id="configContentExam" class="hidden">
        <p class="text-center text-gray-600 p-8">Exam-based configurations are preset and cannot be changed.</p>
      </div>

      <div class="mt-8 flex justify-end">
        <button id="cancelConfigBtn" class="btn btn-secondary mr-4 px-6 py-2 rounded-md">Cancel</button>
        <button id="saveConfigAndStartBtn" class="btn btn-primary px-6 py-2 rounded-md">Save and Continue</button>
      </div>
    </div>
  </section>

<script>
// Firebase Initialization
const firebaseConfig = {
  apiKey: "AIzaSyBzQwhNx972Q2QbDAzdk3qlTGjVb5f7FxI",
  authDomain: "stenomania-dictations.firebaseapp.com",
  projectId: "stenomania-dictations",
  storageBucket: "stenomania-dictations.firebasestorage.app",
  messagingSenderId: "615978138888",
  appId: "1:615978138888:web:eaa08eda5b1a71eb58c0bd"
};

// --- Cloudinary Configuration ---
const CLOUDINARY_CLOUD_NAME = "di2wioi8j"; 
const CLOUDINARY_UPLOAD_PRESET = "live-class-unsigned";

document.addEventListener('DOMContentLoaded', function() {
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();
    
    // NEW: Variable to hold the time difference between server and client
    let serverTimeOffset = 0; 
    let audioSegmentTimeout;
    
    let jsPDF;
    if(window.jspdf) jsPDF = window.jspdf.jsPDF;

    async function uploadToCloudinary(file, progressCallback) {
        const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/auto/upload`;
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
        return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            xhr.open('POST', url, true);
            xhr.upload.onprogress = (event) => {
                if (event.lengthComputable && progressCallback) {
                    const percentage = (event.loaded / event.total) * 100;
                    progressCallback(percentage);
                }
            };
            xhr.onload = () => {
                if (xhr.status >= 200 && xhr.status < 300) {
                    resolve(JSON.parse(xhr.responseText));
                } else {
                    reject(new Error(`Upload failed with status: ${xhr.status}. Response: ${xhr.responseText}`));
                }
            };
            xhr.onerror = () => reject(new Error("Network error during upload."));
            xhr.send(formData);
        });
    }

    let isTouchDevice = false;
    if ("ontouchstart" in window || navigator.maxTouchPoints > 0 || navigator.msMaxTouchPoints > 0) {
        isTouchDevice = true;
        document.body.classList.remove('touch-disabled');
        document.body.classList.add('touch-enabled');
    } else {
        document.body.classList.add('touch-disabled');
    }

    const toastContainer = document.getElementById('toast-container');
    function showToast(message, type = 'info') {
        const icons = { info: 'fas fa-info-circle', success: 'fas fa-check-circle', error: 'fas fa-exclamation-triangle' };
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `<i class="${icons[type]}"></i><p>${message}</p>`;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.remove(), 5000);
    }
    
    const pageContainer = document.getElementById('pageContainer');
    const sidebar = document.getElementById('sidebar');
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const sidebarLoggedInState = document.getElementById('sidebarLoggedInState');
    const sidebarLoggedOutState = document.getElementById('sidebarLoggedOutState');
    const sidebarLoginBtn = document.getElementById('sidebarLoginBtn');
    const sidebarUserName = document.getElementById('sidebarUserName');
    
    // Sidebar navigation buttons
    const sidebarHomeBtn = document.getElementById('sidebarHomeBtn');
    const sidebarProfileBtn = document.getElementById('sidebarProfileBtn');
    const sidebarDashboardBtn = document.getElementById('sidebarDashboardBtn');
    const sidebarPassBtn = document.getElementById('sidebarPassBtn');
    const sidebarLeaderboardBtn = document.getElementById('sidebarLeaderboardBtn');
    const sidebarAdminBtn = document.getElementById('sidebarAdminBtn');
    const sidebarStenoBtn = document.getElementById('sidebarStenoBtn');
    const sidebarLogoutBtn = document.getElementById('sidebarLogoutBtn');
    
    const homeLink = document.getElementById('homeLink');
    const mainView = document.getElementById('main-view');
    const userProfileSection = document.getElementById('userProfileSection');
    const progressSection = document.getElementById('progressSection');
    const adminSection = document.getElementById('adminSection');
    const leaderboardSection = document.getElementById('leaderboardSection');
    const originalTextEl = document.getElementById('originalText');
    const userTextEl = document.getElementById('userText');
    const compareBtn = document.getElementById('compareBtn');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');
    const closeResultsBtnTop = document.getElementById('closeResultsBtnTop');
    const resultsSection = document.getElementById('results');
    const comparisonResultEl = document.getElementById('comparisonResult');
    const statsEl = document.getElementById('stats');
    const moreStatsEl = document.getElementById('moreStats');
    const feedbackEl = document.getElementById('feedback');
    const originalDisplayEl = document.getElementById('originalDisplay');
    const userDisplayEl = document.getElementById('userDisplay');
    const originalTextGroup = document.getElementById('originalTextGroup');
    const timerDisplay = document.getElementById('timerDisplay');
    const loginBtn = document.getElementById('loginBtn');
    const userInfo = document.getElementById('userInfo');
    const userPhoto = document.getElementById('userPhoto');
    const userName = document.getElementById('userName');
    const loginPrompt = document.getElementById('loginPrompt');
    const appContent = document.getElementById('appContent');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const emailLoginBtn = document.getElementById('emailLoginBtn');
    const googleLoginBtn = document.getElementById('googleLoginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const showRegister = document.getElementById('showRegister');
    const showLogin = document.getElementById('showLogin');
    const loginEmail = document.getElementById('loginEmail');
    const loginPassword = document.getElementById('loginPassword');
    const registerName = document.getElementById('registerName');
    const registerEmail = document.getElementById('registerEmail');
    const registerPassword = document.getElementById('registerPassword');
    const confirmPassword = document.getElementById('confirmPassword');
    const videoContainer = document.getElementById('videoContainer');
    const mainInputSection = document.getElementById('mainInputSection');
    const resultTimestampEl = document.getElementById('resultTimestamp');
    const dictationControlContainer = document.getElementById('dictationControlContainer');
    const playDictationBtn = document.getElementById('playDictationBtn');
    const examInterface = document.getElementById('examInterface');
    const newTestSelectionUI = document.getElementById('newTestSelectionUI');
    const categorySelectionView = document.getElementById('categorySelectionView');
    const testListView = document.getElementById('testListView');
    const categoryGrid = document.getElementById('categoryGrid');
    const testListGrid = document.getElementById('testListGrid');
    const testListTitle = document.getElementById('testListTitle');
    const backToCategoriesBtn = document.getElementById('backToCategoriesBtn');
    const testListSearchInput = document.getElementById('testListSearchInput');
    const testActionHeader = document.getElementById('testActionHeader');
    const selectedTestTitle = document.getElementById('selectedTestTitle');
    const chooseAnotherTestBtn = document.getElementById('chooseAnotherTestBtn');
    const activationPrompt = document.getElementById('activationPrompt');
    const activationCodeInput = document.getElementById('activationCodeInput');
    const activatePassBtn = document.getElementById('activatePassBtn');
    const passExpiryInfo = document.getElementById('passExpiryInfo');
    const typingPracticeModal = document.getElementById('typingPracticeModal');
    const closePracticeModalBtn = document.getElementById('closePracticeModalBtn');
    const clearPracticeListBtn = document.getElementById('clearPracticeListBtn');
    const practiceWordChipInner = document.getElementById('practiceWordChipInner');
    const startPracticeSessionBtn = document.getElementById('startPracticeSessionBtn');
    const practiceSetupView = document.getElementById('practiceSetupView');
    const practiceSessionView = document.getElementById('practiceSessionView');
    const practiceTextDisplay = document.getElementById('practiceTextDisplay');
    const practiceTextInput = document.getElementById('practiceTextInput');
    const backToPracticeSetupBtn = document.getElementById('backToPracticeSetupBtn');
    const manualAddWordInput = document.getElementById('manualAddWordInput');
    const manualAddWordBtn = document.getElementById('manualAddWordBtn');
    const repetitionCountInput = document.getElementById('repetitionCountInput');
    const repetitionCountDisplay = document.getElementById('repetitionCountDisplay');
    const printPracticeWordsBtn = document.getElementById('printPracticeWordsBtn');
    const userMenuBtn = document.getElementById('userMenuBtn');
    const userDropdown = document.getElementById('userDropdown');
    const manualModeHeader = document.getElementById('manualModeHeader');
    const backToSeriesFromManualBtn = document.getElementById('backToSeriesFromManualBtn');
    const resultModeTag = document.getElementById('resultModeTag');
    const aiFeatureBanner = document.getElementById('aiFeatureBanner');
    const ctaAiBannerBtn = document.getElementById('ctaAiBannerBtn');
    const startTranscriptionBtn = document.getElementById('startTranscriptionBtn');
    const configureSessionModal = document.getElementById('configureSessionModal');
    const cancelConfigBtn = document.getElementById('cancelConfigBtn');
    const saveConfigAndStartBtn = document.getElementById('saveConfigAndStartBtn');
    const configTime = document.getElementById('configTime');
    const configCustomTimeContainer = document.getElementById('configCustomTimeContainer');


    // NEW: Rank Modal Elements
    const rankModal = document.getElementById('rankModal');
    const closeRankModal = document.getElementById('closeRankModal');
    const rankModalContent = document.getElementById('rankModalContent');

    // NEW: Forgot Password elements
    const forgotPasswordForm = document.getElementById('forgotPasswordForm');
    const showForgotPassword = document.getElementById('showForgotPassword');
    const backToLoginFromForgot = document.getElementById('backToLoginFromForgot');
    const sendResetLinkBtn = document.getElementById('sendResetLinkBtn');
    const resetEmail = document.getElementById('resetEmail');

    // Dropdown menu buttons
    const myProfileBtn = document.getElementById('myProfileBtn');
    const myProgressBtn = document.getElementById('myProgressBtn');
    const yourStenoBtn = document.getElementById('yourStenoBtn');
    const adminBtn = document.getElementById('adminBtn');
    const leaderboardBtn = document.getElementById('leaderboardBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    let currentUser = null;
    const ADMIN_EMAILS = ["anishkumar18034@gmail.com", "mallikachauhan774@gmail.com"];
    let allFetchedTests = [];
    let timerInterval;
    let saveStateInterval;
    let endTime;
    window.testActive = false;
    let isExamMode = false;
    let practiceWords = new Set();
    let practiceSessionState = { words: [], currentIndex: 0 };
    let startTime = null;
    let userProfileAttemptsArray = [];
    let profileAttemptsCurrentPage = 1;
    const profileAttemptsPerPage = 10;
    let progressChartInstance = null;
    let currentTestDetails = { title: "Custom Test", category: "general", videoUrl: null, solutionAudio: null, solutionVideoUrl: null, dictationAudio: null };
    let allLeaderboardAttempts = [];
    let filteredLeaderboardAttempts = [];
    let leaderboardCurrentPage = 1;
    const leaderboardPerPage = 15;
    let leaderboardSort = { key: 'stats.accuracy', order: 'desc' };
    let solutionPlayerInterval;

    // NEW: Transcription configuration object
    let transcriptionConfig = {
        backspace: 'enabled',
        spellingWeight: 1,
        capitalizationWeight: 1,
        punctuationWeight: 1,
    };
    
    function enterFullscreen(element) { if (element.requestFullscreen) { element.requestFullscreen().catch(err => { console.error(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`); }); } else if (element.mozRequestFullScreen) { element.mozRequestFullScreen(); } else if (element.webkitRequestFullscreen) { element.webkitRequestFullscreen(); } else if (element.msRequestFullscreen) { element.msRequestFullscreen(); }}
    function exitFullscreen() { if (document.exitFullscreen) { if (document.fullscreenElement) { document.exitFullscreen(); } } else if (document.mozCancelFullScreen) { document.mozCancelFullScreen(); } else if (document.webkitExitFullscreen) { document.webkitExitFullscreen(); } else if (document.msExitFullscreen) { document.msExitFullscreen(); }}

    const sidebarLinkMap = {
        main: 'sidebarHomeBtn',
        profile: 'sidebarProfileBtn',
        pass: 'sidebarPassBtn', 
        progress: 'sidebarDashboardBtn',
        leaderboard: 'sidebarLeaderboardBtn',
        admin: 'sidebarAdminBtn',
        steno: 'sidebarStenoBtn'
    };

    function setActiveNav(view) {
        Object.values(sidebarLinkMap).forEach(id => {
            document.getElementById(id)?.classList.remove('active');
        });
        const activeId = sidebarLinkMap[view] || sidebarLinkMap.main;
        if (activeId) {
            document.getElementById(activeId)?.classList.add('active');
        }
    }

    function showView(view) {
        mainView.classList.add('hidden');
        userProfileSection.classList.add('hidden');
        progressSection.classList.add('hidden');
        adminSection.classList.add('hidden');
        leaderboardSection.classList.add('hidden');
        examInterface.classList.add('hidden');
        userDropdown.classList.add('hidden');
        
        if (!sidebar.classList.contains('lg:flex')) {
            sidebar.classList.add('hidden');
        }
        
        if (view === 'main') mainView.classList.remove('hidden');
        else if (view === 'profile') userProfileSection.classList.remove('hidden');
        else if (view === 'progress') progressSection.classList.remove('hidden');
        else if (view === 'admin') adminSection.classList.remove('hidden');
        else if (view === 'leaderboard') leaderboardSection.classList.remove('hidden');
        else if (view === 'exam') examInterface.classList.remove('hidden');
        
        setActiveNav(view);
    }
    
    function showAppContentAfterLogin() {
        loginBtn.classList.add('hidden');
        userInfo.classList.remove('hidden');
        userPhoto.src = currentUser.photoURL || `https://www.gravatar.com/avatar/${currentUser.uid}?d=identicon&s=40`;
        userName.textContent = (currentUser.displayName || 'User').split(' ')[0];
        sidebarUserName.textContent = `Hi, ${currentUser.displayName || 'User'}`;
        
        loginPrompt.classList.add('hidden');
        activationPrompt.classList.add('hidden');
        appContent.classList.remove('hidden');
        
        const isAdmin = ADMIN_EMAILS.includes(currentUser.email);
        sidebarAdminBtn.classList.toggle('hidden', !isAdmin);
        adminBtn.classList.toggle('hidden', !isAdmin);
        
        // Show leaderboard to all logged-in users
        sidebarLeaderboardBtn.classList.remove('hidden');
        leaderboardBtn.classList.remove('hidden');

        if (currentUser.displayName) {
             database.ref(`users/${currentUser.uid}/displayName`).set(currentUser.displayName);
        }

        loadPracticeWordsFromFirebase();
        fetchAndDisplayGlobalTests();
        checkForUnfinishedExam();
    }
    
    // NEW: Function to sync time with the Firebase server
    function syncTimeWithServer() {
        const offsetRef = database.ref(".info/serverTimeOffset");
        offsetRef.on("value", function(snap) {
            serverTimeOffset = snap.val() || 0;
            console.log(`Time synchronized with server. Offset is: ${serverTimeOffset}ms`);
        });
    }

    function checkUserPassStatus() {
        if (!currentUser) return;
        if (ADMIN_EMAILS.includes(currentUser.email)) {
            showAppContentAfterLogin();
            passExpiryInfo.textContent = 'Admin Access';
            passExpiryInfo.classList.remove('hidden');
            return;
        }
        const passesRef = database.ref(`users/${currentUser.uid}/testPasses`);
        passesRef.once('value', snapshot => {
            const passesData = snapshot.val();
            // UPDATED: Use server-synced time for accurate check
            const now = new Date().getTime() + serverTimeOffset;
            let hasAnyActivePass = false;
            let hasAllAccessPass = false;
            let activePassCategories = [];
            const updates = {};
            
            if (passesData) {
                // First, check for a valid 'all' access pass
                if (passesData.all && passesData.all.active && passesData.all.expiresAt > now) {
                    hasAllAccessPass = true;
                }

                for (const category in passesData) {
                    const pass = passesData[category];
                    if (pass.active && pass.expiresAt > now) {
                        hasAnyActivePass = true;
                        if (category !== 'all') { // Don't add 'all' to the display list
                           activePassCategories.push(getCategoryDisplayName(category));
                        }
                    } else if (pass.active && pass.expiresAt <= now) {
                        updates[`/users/${currentUser.uid}/testPasses/${category}/active`] = false;
                    }
                }
            }
            if (Object.keys(updates).length > 0) {
                database.ref().update(updates);
            }

            if (hasAllAccessPass || hasAnyActivePass) {
                showAppContentAfterLogin();
                if (hasAllAccessPass) {
                    passExpiryInfo.textContent = `All-Access Pass Active`;
                } else {
                    passExpiryInfo.textContent = `Active: ${activePassCategories.join(', ')}`;
                }
                passExpiryInfo.classList.remove('hidden');
            } else {
                loginBtn.classList.add('hidden');
                userInfo.classList.remove('hidden');
                userPhoto.src = currentUser.photoURL || `https://www.gravatar.com/avatar/${currentUser.uid}?d=identicon&s=40`;
                userName.textContent = (currentUser.displayName || 'User').split(' ')[0];
                sidebarUserName.textContent = `Hi, ${currentUser.displayName || 'User'}`;
                loginPrompt.classList.add('hidden');
                appContent.classList.add('hidden');
                activationPrompt.classList.remove('hidden');
            }
        });
    }

    function isUserPassValid(categoryKey) {
        return new Promise(resolve => {
            if (!currentUser) return resolve(false);
            if (ADMIN_EMAILS.includes(currentUser.email)) return resolve(true);
            if (!categoryKey) {
                showToast("Cannot validate pass without a category.", "error");
                return resolve(false);
            }
            
            const userPassesRef = database.ref(`users/${currentUser.uid}/testPasses`);
            userPassesRef.once('value', snapshot => {
                const passesData = snapshot.val();
                // UPDATED: Use server-synced time for accurate check
                const now = new Date().getTime() + serverTimeOffset;
                let hasValidPass = false;

                if (passesData) {
                    // 1. Check for an active 'all' access pass first.
                    const allAccessPass = passesData['all'];
                    if (allAccessPass && allAccessPass.active && allAccessPass.expiresAt > now) {
                        hasValidPass = true;
                    }

                    // 2. If no all-access pass, check for the specific category pass.
                    if (!hasValidPass) {
                        const specificPass = passesData[categoryKey];
                        if (specificPass && specificPass.active && specificPass.expiresAt > now) {
                            hasValidPass = true;
                        }
                    }
                }
                
                if (hasValidPass) {
                    resolve(true);
                } else {
                    // This logic only runs if no valid pass was found (neither 'all' nor specific)
                    showToast(`You need a valid pass for the ${getCategoryDisplayName(categoryKey)} series or an All-Access pass.`, "error");
                    activationPrompt.classList.remove('hidden');
                    appContent.classList.add('hidden');
                    resolve(false);
                }
            });
        });
    }
    
    function activateUserPass() {
        const code = activationCodeInput.value.trim().toUpperCase();
        if (!code) { showToast('Please enter a code.', 'error'); return; }
        activatePassBtn.disabled = true;
        activatePassBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Activating...';
        const codesRef = database.ref('activationCodes');
        codesRef.orderByChild('code').equalTo(code).once('value', snapshot => {
            if (!snapshot.exists()) {
                showToast('Invalid activation code.', 'error');
                resetActivateButton();
                return;
            }
            let codeId, codeData;
            snapshot.forEach(child => { codeId = child.key; codeData = child.val(); });
            if (codeData.isUsed) {
                showToast('This code has already been used.', 'error');
                resetActivateButton();
                return;
            }
            if (!codeData.category) {
                showToast('This activation code is invalid (missing category). Contact admin.', 'error');
                resetActivateButton();
                return;
            }
            const updates = {};
            const userPassData = {
                active: true,
                expiresAt: codeData.expiresAt,
                codeUsed: code,
                activatedOn: firebase.database.ServerValue.TIMESTAMP,
                planName: codeData.planName || `${getCategoryDisplayName(codeData.category)} - ${codeData.totalDays} Day Pass`,
                totalDays: codeData.totalDays || 30
            };
            updates[`/users/${currentUser.uid}/testPasses/${codeData.category}`] = userPassData;
            updates[`/activationCodes/${codeId}/isUsed`] = true;
            updates[`/activationCodes/${codeId}/usedBy`] = currentUser.uid;
            updates[`/activationCodes/${codeId}/usedOn`] = firebase.database.ServerValue.TIMESTAMP;
            updates[`/activationCodes/${codeId}/usedByName`] = currentUser.displayName || 'Anonymous';
            database.ref().update(updates)
                .then(() => {
                    showToast(`Success! Your pass for the ${getCategoryDisplayName(codeData.category)} category is now active.`, 'success');
                    activationPrompt.classList.add('hidden');
                    checkUserPassStatus();
                })
                .catch(error => {
                    showToast('An error occurred. Please try again.', 'error');
                    console.error('Activation error:', error);
                    resetActivateButton();
                });
        });
    }
    function resetActivateButton() { activatePassBtn.disabled = false; activatePassBtn.innerHTML = 'Activate'; }
    
    auth.onAuthStateChanged(user => {
        currentUser = user;
        if (user) {
            // Logged In
            // UPDATED: Sync time with server as soon as user logs in
            syncTimeWithServer(); 
            sidebarLoggedInState.classList.remove('hidden');
            sidebarLoggedOutState.classList.add('hidden');
            checkUserPassStatus(); 
        } else {
            // Logged Out
            // UPDATED: Reset time offset on logout
            serverTimeOffset = 0; 
            sidebarLoggedInState.classList.add('hidden');
            sidebarLoggedOutState.classList.remove('hidden');
            
            // Reset UI to default logged-out state
            practiceWords.clear();
            updatePracticeUI();
            loginBtn.classList.remove('hidden');
            userInfo.classList.add('hidden');
            loginPrompt.classList.remove('hidden');
            appContent.classList.add('hidden');
            activationPrompt.classList.add('hidden');
            passExpiryInfo.classList.add('hidden');
            resetComparisonUI();
            showView('main');
        }
    });

    userMenuBtn.addEventListener('click', () => userDropdown.classList.toggle('hidden'));
    mobileMenuBtn.addEventListener('click', () => {
        sidebar.classList.toggle('hidden');
        sidebar.classList.add('absolute', 'z-40');
        sidebar.classList.remove('lg:flex');
    });
    window.addEventListener('click', (e) => {
        if (!userMenuBtn.contains(e.target) && !userDropdown.contains(e.target)) { userDropdown.classList.add('hidden'); }
        if (!sidebar.contains(e.target) && !mobileMenuBtn.contains(e.target) && !sidebar.classList.contains('lg:flex')) { sidebar.classList.add('hidden'); }
    });
    activatePassBtn.addEventListener('click', activateUserPass);
    
    function requiresLogin(handlerFn) {
        return function(e) {
            e.preventDefault();
            if (!currentUser) {
                showToast('Please log in to access this feature.', 'info');
                loginPrompt.scrollIntoView({ behavior: 'smooth' });
                return;
            }
            handlerFn(e);
        }
    }

    const handleHomeClick = (e) => { e.preventDefault(); showView('main'); resetComparisonUI(); };
    const handleProfileClick = (e) => { showView('profile'); loadUserProfileData(); };
    const handleProgressClick = (e) => { showView('progress'); loadUserProgressData(); };
    const handleAdminClick = (e) => { showView('admin'); prepareAdminFormForAdd(); };
    const handleLeaderboardClick = (e) => { showView('leaderboard'); loadLeaderboardData(); };
    const handleStenoClick = (e) => { showView('main'); showManualTestView(); setActiveNav('steno'); };
    const handleLogoutClick = (e) => { e.preventDefault(); auth.signOut(); };

    homeLink.addEventListener('click', handleHomeClick);
    sidebarHomeBtn.addEventListener('click', handleHomeClick);
    sidebarLoginBtn.addEventListener('click', () => { loginPrompt.scrollIntoView({ behavior: 'smooth' }); });

    sidebarProfileBtn.addEventListener('click', requiresLogin(handleProfileClick));
    myProfileBtn.addEventListener('click', requiresLogin(handleProfileClick));

    sidebarPassBtn.addEventListener('click', requiresLogin((e) => { showView('profile'); loadUserProfileData(); setActiveNav('pass'); }));

    sidebarDashboardBtn.addEventListener('click', requiresLogin(handleProgressClick));
    myProgressBtn.addEventListener('click', requiresLogin(handleProgressClick));

    sidebarAdminBtn.addEventListener('click', requiresLogin(handleAdminClick));
    adminBtn.addEventListener('click', requiresLogin(handleAdminClick));

    sidebarLeaderboardBtn.addEventListener('click', requiresLogin(handleLeaderboardClick));
    leaderboardBtn.addEventListener('click', requiresLogin(handleLeaderboardClick));
    
    sidebarStenoBtn.addEventListener('click', requiresLogin(handleStenoClick));
    yourStenoBtn.addEventListener('click', requiresLogin(handleStenoClick));
    
    sidebarLogoutBtn.addEventListener('click', handleLogoutClick);
    logoutBtn.addEventListener('click', handleLogoutClick);
    
    function checkForUnfinishedExam() {
        const savedStateJSON = sessionStorage.getItem('activeExamState');
        if (!savedStateJSON) { showView('main'); return; }
        const savedState = JSON.parse(savedStateJSON);
        if (currentUser && savedState.userId !== currentUser.uid) { sessionStorage.removeItem('activeExamState'); showView('main'); return; }
        const timeRemaining = savedState.endTime - new Date().getTime();
        if (timeRemaining < 0) {
            showToast("Your previous test's time ran out. Submitting results now.", "warning");
            currentTestDetails = savedState.currentTestDetails;
            originalTextEl.value = savedState.originalText;
            userTextEl.value = savedState.userText;
            startTime = new Date(savedState.startTime);
            compareTexts();
            sessionStorage.removeItem('activeExamState');
            return;
        }
        if (confirm("You have an unfinished test. Would you like to resume?")) { resumeExam(savedState); } 
        else { sessionStorage.removeItem('activeExamState'); showView('main'); }
    }

    function resumeExam(state) {
        isExamMode = true; testActive = true; currentTestDetails = state.currentTestDetails;
        endTime = new Date(state.endTime); startTime = new Date(state.startTime);
        showView('exam'); renderExamInterface(state.originalText, state.userText);
        updateTimerDisplay();
        timerInterval = setInterval(updateTimerDisplay, 1000);
        saveStateInterval = setInterval(saveExamProgress, 3000);
    }
    
    function saveExamProgress() {
        if (!isExamMode || !testActive) return;
        const savedStateJSON = sessionStorage.getItem('activeExamState');
        const examUserText = document.getElementById('examUserText');
        if (savedStateJSON && examUserText) {
            const savedState = JSON.parse(savedStateJSON);
            savedState.userText = examUserText.value;
            if (currentUser) savedState.userId = currentUser.uid; 
            sessionStorage.setItem('activeExamState', JSON.stringify(savedState));
        }
    }
    chooseAnotherTestBtn.addEventListener('click', resetTypingArea);
    backToSeriesFromManualBtn.addEventListener('click', resetTypingArea);
    if(userTextEl) { userTextEl.addEventListener('input', function() { if (!startTime) { startTime = new Date(); } }); }
    
    // --- Auth Form Switching Logic ---
    showRegister.addEventListener('click', (e) => {
        e.preventDefault();
        loginForm.classList.add('hidden');
        forgotPasswordForm.classList.add('hidden');
        registerForm.classList.remove('hidden');
    });
    showLogin.addEventListener('click', (e) => {
        e.preventDefault();
        registerForm.classList.add('hidden');
        forgotPasswordForm.classList.add('hidden');
        loginForm.classList.remove('hidden');
    });
    showForgotPassword.addEventListener('click', (e) => {
        e.preventDefault();
        loginForm.classList.add('hidden');
        registerForm.classList.add('hidden');
        forgotPasswordForm.classList.remove('hidden');
    });
    backToLoginFromForgot.addEventListener('click', (e) => {
        e.preventDefault();
        forgotPasswordForm.classList.add('hidden');
        loginForm.classList.remove('hidden');
    });
    
    // --- Auth Action Logic ---
    emailLoginBtn.addEventListener('click', () => { const email = loginEmail.value.trim(); const password = loginPassword.value.trim(); if (!email || !password) { showToast('Please enter both email and password', 'error'); return; } auth.signInWithEmailAndPassword(email, password).catch(error => showToast('Login failed: ' + error.message, 'error')); });
    
    sendResetLinkBtn.addEventListener('click', () => {
        const email = resetEmail.value.trim();
        if (!email) {
            showToast('Please enter your email address.', 'error');
            return;
        }
        sendResetLinkBtn.disabled = true;
        sendResetLinkBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';
        auth.sendPasswordResetEmail(email)
            .then(() => {
                showToast('Password reset email sent! Please check your inbox.', 'success');
                forgotPasswordForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
            })
            .catch((error) => {
                let errorMessage = 'An error occurred. Please try again.';
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'No user found with this email address.';
                }
                showToast(errorMessage, 'error');
                console.error('Password reset error:', error);
            })
            .finally(() => {
                sendResetLinkBtn.disabled = false;
                sendResetLinkBtn.textContent = 'Send Reset Link';
            });
    });

    const passwordInput = document.getElementById('registerPassword');
    const strengthIndicator = document.getElementById('passwordStrengthIndicator');
    const checks = {
        length: document.getElementById('strength-length'),
        lowercase: document.getElementById('strength-lowercase'),
        uppercase: document.getElementById('strength-uppercase'),
        number: document.getElementById('strength-number')
    };

    passwordInput.addEventListener('focus', () => {
        strengthIndicator.classList.remove('hidden');
    });

    passwordInput.addEventListener('blur', () => {
        if (passwordInput.value.length === 0) {
            strengthIndicator.classList.add('hidden');
        }
    });

    passwordInput.addEventListener('input', () => {
        const password = passwordInput.value;
        
        // Length check
        updateIndicator(checks.length, password.length >= 8);
        
        // Lowercase check
        updateIndicator(checks.lowercase, /[a-z]/.test(password));
        
        // Uppercase check
        updateIndicator(checks.uppercase, /[A-Z]/.test(password));
        
        // Number check
        updateIndicator(checks.number, /[0-9]/.test(password));
    });

    function updateIndicator(element, isValid) {
        const icon = element.querySelector('i');
        if (isValid) {
            element.classList.remove('invalid');
            element.classList.add('valid');
            icon.classList.remove('fa-times');
            icon.classList.add('fa-check');
        } else {
            element.classList.remove('valid');
            element.classList.add('invalid');
            icon.classList.remove('fa-check');
            icon.classList.add('fa-times');
        }
    }

    registerBtn.addEventListener('click', () => {
        const name = registerName.value.trim(); const email = registerEmail.value.trim(); const password = registerPassword.value.trim(); const confirmVal = confirmPassword.value.trim();
        if (!name || !email || !password || !confirmVal) { showToast('Please fill in all fields', 'error'); return; }
        if (password !== confirmVal) { showToast('Passwords do not match', 'error'); return; }
        if (password.length < 8 || !/[a-z]/.test(password) || !/[A-Z]/.test(password) || !/[0-9]/.test(password)) {
             showToast('Password does not meet all the strength requirements.', 'error');
             return;
        }
        auth.createUserWithEmailAndPassword(email, password)
            .then(cred => cred.user.updateProfile({ displayName: name }))
            .then(() => { showToast('Registration successful! You are now logged in.', 'success'); resetAuthForms(); registerForm.classList.add('hidden'); loginForm.classList.remove('hidden'); })
            .catch(error => showToast('Registration failed: ' + error.message, 'error'));
    });

    googleLoginBtn.addEventListener('click', () => { const provider = new firebase.auth.GoogleAuthProvider(); auth.signInWithPopup(provider).catch(error => showToast('Google login failed. Please try again.', 'error')); });
    
    // --- NEW MODAL LOGIC ---
    startTranscriptionBtn.addEventListener('click', () => {
        const originalText = originalTextEl.value;
        if (!originalText.trim()) { showToast("Please select a test or paste text first.", "error"); return; }
        configureSessionModal.classList.remove('hidden');
    });

    cancelConfigBtn.addEventListener('click', () => {
        configureSessionModal.classList.add('hidden');
    });

    configTime.addEventListener('change', () => {
        if (configTime.value === 'custom') {
            configCustomTimeContainer.classList.remove('hidden');
        } else {
            configCustomTimeContainer.classList.add('hidden');
        }
    });

    saveConfigAndStartBtn.addEventListener('click', () => {
        // 1. Read and save config
        transcriptionConfig.backspace = document.getElementById('configBackspace').value;
        transcriptionConfig.spellingWeight = parseFloat(document.getElementById('configSpelling').value);
        transcriptionConfig.capitalizationWeight = parseFloat(document.getElementById('configCapitalization').value);
        transcriptionConfig.punctuationWeight = parseFloat(document.getElementById('configPunctuation').value);

        // 2. Get time
        let minutes;
        if (configTime.value === 'custom') {
            minutes = parseInt(document.getElementById('configCustomTimeInput').value, 10);
            if (isNaN(minutes) || minutes < 1 || minutes > 180) {
                showToast('Please enter a valid number of minutes (1-180).', 'error');
                return;
            }
        } else {
            minutes = parseInt(configTime.value, 10);
        }

        // 3. Hide modal and start
        configureSessionModal.classList.add('hidden');
        startTimer(minutes);
    });

    if(compareBtn) { compareBtn.addEventListener('click', () => { stopTimer(); compareTexts(); }); }
    downloadPdfBtn.addEventListener('click', downloadAsPdf);
    closeResultsBtnTop.addEventListener('click', () => {
        location.reload();
    });
    resultsSection.addEventListener('contextmenu', e => e.preventDefault());
    resultsSection.addEventListener('copy', e => { e.preventDefault(); showToast('Copying is disabled for the results.', 'info'); });
    window.updatePlayButtonUI = function(isPlaying) { if (playDictationBtn) { if (isPlaying) { playDictationBtn.innerHTML = '<i class="fas fa-pause mr-2"></i>Pause Dictation'; } else { playDictationBtn.innerHTML = '<i class="fas fa-play mr-2"></i>Play Dictation'; } } }
    
    playDictationBtn.addEventListener('click', () => {
        const selector = document.getElementById('dictationLengthSelector');
        const value = selector ? selector.value : 'full';

        const playFullAudio = () => {
            if (player && typeof player.getPlayerState === 'function') {
                const playerState = player.getPlayerState();
                if (playerState === YT.PlayerState.PLAYING) {
                    player.pauseVideo();
                } else {
                    player.playVideo();
                }
            } else if (audioPlayer) {
                if (!audioPlayer.paused) {
                    audioPlayer.pause();
                } else {
                    audioPlayer.play();
                }
            } else {
                showToast("No dictation media is loaded.", "error");
            }
        };

        if (value === 'full') {
            playFullAudio();
        } else {
            const [mode, wordCountStr] = value.split('-');
            const wordCount = parseInt(wordCountStr, 10);
            const totalWords = originalTextEl.value.split(/\s+/).filter(Boolean).length;
            const duration = (player && typeof player.getDuration === 'function') ? player.getDuration() : (audioPlayer ? audioPlayer.duration : 0);

            if (duration > 0 && totalWords > 0 && !isNaN(wordCount)) {
                const avgTimePerWord = duration / totalWords;
                let startTime = 0;
                let playDuration = wordCount * avgTimePerWord;

                if (mode === 'last') {
                    startTime = Math.max(0, duration - playDuration);
                }
                playAudioSegment(startTime, playDuration);
            } else {
                playFullAudio();
            }
        }
    });

    function playAudioSegment(startTime, playDuration) {
        clearTimeout(audioSegmentTimeout);

        const pauseFunction = () => {
            if (player && typeof player.pauseVideo === 'function') player.pauseVideo();
            if (audioPlayer) audioPlayer.pause();
        };

        if (player && typeof player.seekTo === 'function') {
            player.seekTo(startTime, true);
            player.playVideo();
        } else if (audioPlayer) {
            audioPlayer.currentTime = startTime;
            audioPlayer.play();
        }

        audioSegmentTimeout = setTimeout(pauseFunction, playDuration * 1000);
    }
    
    document.getElementById('closeExplainModal').addEventListener('click', () => document.getElementById('explainModal').classList.add('hidden'));
    document.getElementById('closeExplainModalBtn').addEventListener('click', () => document.getElementById('explainModal').classList.add('hidden'));
    ctaAiBannerBtn.addEventListener('click', () => { categorySelectionView.scrollIntoView({ behavior: 'smooth' }); });
    function resetAuthForms() { loginEmail.value = ''; loginPassword.value = ''; registerName.value = ''; registerEmail.value = ''; registerPassword.value = ''; confirmPassword.value = ''; resetEmail.value = ''; }
    
    function resetTypingArea() {
        mainInputSection.classList.add('hidden'); newTestSelectionUI.classList.remove('hidden'); categorySelectionView.classList.remove('hidden'); testListView.classList.add('hidden');
        manualModeHeader.classList.add('hidden'); testActionHeader.classList.add('hidden');
        if (window.player && typeof window.player.destroy === 'function') { window.player.destroy(); window.player = null; }
        if (audioPlayer) { audioPlayer.pause(); audioPlayer = null; }
        document.getElementById('audioPlayerContainer').innerHTML = '';
        document.getElementById('audioPlayerContainer').classList.add('hidden');
        
        videoContainer.classList.remove('dictation-mode-hidden', 'audio-player-wrapper'); 

        videoContainer.innerHTML = ''; videoContainer.classList.add('hidden'); dictationControlContainer.classList.add('hidden');
        originalTextEl.value = '';
        if(userTextEl) { userTextEl.value = ''; userTextEl.readOnly = true; userTextEl.classList.add('bg-gray-200', 'cursor-not-allowed', 'hidden'); }
        if(compareBtn) compareBtn.classList.add('hidden');
        startTranscriptionBtn.classList.add('hidden');
        testActive = false; isExamMode = false; startTime = null; stopTimer();
        timerDisplay.classList.add('hidden'); originalTextGroup.classList.remove('hidden');
        aiFeatureBanner.classList.remove('hidden');
        document.getElementById('sidebar').style.display = ''; // Restore sidebar visibility
        sessionStorage.removeItem('activeExamState'); showView('main');
    }

    function resetComparisonUI() {
        showView('main'); resetTypingArea(); 
        comparisonResultEl.innerHTML = ''; statsEl.innerHTML = ''; moreStatsEl.innerHTML = ''; feedbackEl.innerHTML = '';
        originalDisplayEl.textContent = '';
        if(userDisplayEl) userDisplayEl.textContent = '';
        
        const audioContainer = document.getElementById('audioSolutionContainer');
        if (audioContainer) { audioContainer.classList.add('hidden'); document.getElementById('audioSolutionPlayer').innerHTML = ''; }
        
        clearInterval(solutionPlayerInterval);
        if (solutionPlayer && typeof solutionPlayer.destroy === 'function') {
            solutionPlayer.destroy();
            solutionPlayer = null;
        }
        const videoSolContainer = document.getElementById('videoSolutionContainer');
        if(videoSolContainer) {
            videoSolContainer.classList.add('hidden');
            videoSolContainer.innerHTML = '';
        }
    }
    async function startTimer(minutes) {
        if (!currentTestDetails.category) { showToast("Cannot start timer for a test without a category.", "error"); return; }
        if (testActive) stopTimer();
        if (window.player && typeof window.player.stopVideo === 'function') {
            window.player.stopVideo();
        }
        if (window.audioPlayer) {
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
        }
        const originalText = originalTextEl.value;
        if (!originalText.trim()) { showToast("Please select a test or paste text first.", "error"); return; }
        isExamMode = true; testActive = true; startTime = new Date(); endTime = new Date(startTime.getTime() + minutes * 60000);
        showView('exam'); renderExamInterface(originalText, '');
        const examState = { userId: currentUser ? currentUser.uid : null, isExamMode: true, originalText: originalText, userText: '', startTime: startTime.getTime(), endTime: endTime.getTime(), currentTestDetails: currentTestDetails };
        sessionStorage.setItem('activeExamState', JSON.stringify(examState));
        updateTimerDisplay();
        timerInterval = setInterval(updateTimerDisplay, 1000);
        saveStateInterval = setInterval(saveExamProgress, 3000);
    }
    function triggerComparisonFromExam() {
        if (!testActive) return; 
        const examUserText = document.getElementById('examUserText');
        const examOriginalTextHolder = document.getElementById('examOriginalTextHolder');
        originalTextEl.value = examOriginalTextHolder.value;
        if(userTextEl) userTextEl.value = examUserText.value;
        examUserText.readOnly = true; stopTimer(); compareTexts();
    }
    function stopTimer() { clearInterval(timerInterval); clearInterval(saveStateInterval); testActive = false; }
    function updateTimerDisplay() {
        const now = new Date(); const remaining = endTime - now;
        const examTimerDisplay = document.getElementById('examTimerDisplay');
        if (remaining <= 0) {
            if(examTimerDisplay) examTimerDisplay.textContent = "TIME'S UP!";
            triggerComparisonFromExam(); lockTest(); return;
        }
        const minutes = Math.floor((remaining % 3600000) / 60000);
        const seconds = Math.floor((remaining % 60000) / 1000);
        const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        if(examTimerDisplay) examTimerDisplay.textContent = `Time Left: ${timeString}`;
    }
    function lockTest() {
        if(userTextEl) { userTextEl.readOnly = true; userTextEl.classList.add('bg-gray-200', 'cursor-not-allowed'); }
        const examUserText = document.getElementById('examUserText');
        if(isExamMode && examUserText) { examUserText.readOnly = true; }
    }
    function compareTexts() {
        const originalTextRaw = originalTextEl.value;
        const userTextRaw = userTextEl ? userTextEl.value : "";
        if (!originalTextRaw && !userTextRaw) { showToast('Please enter both original text and your transcription.', 'error'); return; }
        if (isExamMode) { exitFullscreen(); }
        
        let textToCompare = originalTextRaw;
        const selectedLength = document.getElementById('dictationLengthSelector').value;
        
        if (selectedLength !== 'full') {
            const [mode, countStr] = selectedLength.split('-');
            const wordCountLimit = parseInt(countStr, 10);
            const allOriginalWords = originalTextRaw.split(/\s+/).filter(Boolean);

            if (!isNaN(wordCountLimit)) {
                if (mode === 'first') {
                    textToCompare = allOriginalWords.slice(0, wordCountLimit).join(' ');
                } else if (mode === 'last') {
                    textToCompare = allOriginalWords.slice(-wordCountLimit).join(' ');
                }
            }
        }

        const originalWordsForComparison = processText(textToCompare);
        const userWordsForComparison = processText(userTextRaw);

        const originalTextForDisplay = originalTextRaw;
        const testTimestamp = new Date().getTime();
        const testTitle = currentTestDetails.title || "Custom Test";
        const testCategory = currentTestDetails.category || 'general';
        const comparison = compareParagraphsLCS(originalWordsForComparison, userWordsForComparison);
        
        displayAppliedRules(transcriptionConfig);
        displayComparison(comparison);
        displayStats(comparison.stats, testTimestamp);
        displayFeedback(comparison.stats);
        displayFullTexts(originalTextForDisplay, userTextRaw);
        displayAudioSolution();
        displayVideoSolution();
        resultsSection.classList.remove('hidden');
        if(compareBtn) compareBtn.classList.add('hidden');
        startTranscriptionBtn.classList.add('hidden');
        if (currentUser) {
            saveAttemptToFirebase(testTitle, testCategory, comparison.stats, comparison.html, originalTextForDisplay, userTextRaw, testTimestamp);
        }
        sessionStorage.removeItem('activeExamState');
    }
    
    function renderSolutionAudioPlayer(container, url) {
        container.innerHTML = ''; // Clear previous content
        const prefix = 'solution';

        const audioEl = document.createElement('audio');
        audioEl.id = `${prefix}-audio-player`;
        audioEl.src = url;
        container.appendChild(audioEl);

        container.innerHTML += `
            <div id="${prefix}-custom-player" class="w-full">
                <div class="relative">
                    <input type="range" id="${prefix}-seek-slider" class="w-full h-2 bg-indigo-100 rounded-lg appearance-none cursor-pointer solution-seek-slider" value="0" step="0.1" style="background-size: 0% 100%;">
                </div>
                <div class="flex justify-between items-center text-sm text-gray-600 mt-2 font-mono">
                    <div class="flex items-center gap-3">
                        <button id="${prefix}-play-pause-btn" class="text-indigo-600 hover:text-indigo-800 text-xl transition-transform transform hover:scale-110" title="Play/Pause"><i class="fas fa-play"></i></button>
                        <button id="${prefix}-rewind-btn" class="text-indigo-600 hover:text-indigo-800 text-lg transition-transform transform hover:scale-110" title="Rewind 10s"><i class="fas fa-undo"></i></button>
                    </div>
                    <div class="flex items-center gap-2">
                        <span id="${prefix}-current-time">0:00</span>
                        <span>/</span>
                        <span id="${prefix}-duration">0:00</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <button id="${prefix}-forward-btn" class="text-indigo-600 hover:text-indigo-800 text-lg transition-transform transform hover:scale-110" title="Forward 10s"><i class="fas fa-redo"></i></button>
                    </div>
                </div>
            </div>`;

        const seekSlider = document.getElementById(`${prefix}-seek-slider`);
        const currentTimeEl = document.getElementById(`${prefix}-current-time`);
        const durationEl = document.getElementById(`${prefix}-duration`);
        const rewindBtn = document.getElementById(`${prefix}-rewind-btn`);
        const forwardBtn = document.getElementById(`${prefix}-forward-btn`);
        const playPauseBtn = document.getElementById(`${prefix}-play-pause-btn`);
        const playPauseIcon = playPauseBtn.querySelector('i');

        const formatTime = (time) => {
            if (isNaN(time)) return "0:00";
            const minutes = Math.floor(time / 60);
            const seconds = Math.floor(time % 60);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        };

        playPauseBtn.addEventListener('click', () => {
            if (audioEl.paused) audioEl.play();
            else audioEl.pause();
        });
        audioEl.addEventListener('play', () => playPauseIcon.className = 'fas fa-pause');
        audioEl.addEventListener('pause', () => playPauseIcon.className = 'fas fa-play');
        audioEl.addEventListener('ended', () => playPauseIcon.className = 'fas fa-play');

        audioEl.addEventListener('loadedmetadata', () => {
            durationEl.textContent = formatTime(audioEl.duration);
            seekSlider.max = audioEl.duration;
        });

        audioEl.addEventListener('timeupdate', () => {
            currentTimeEl.textContent = formatTime(audioEl.currentTime);
            seekSlider.value = audioEl.currentTime;
            const progressPercent = (audioEl.currentTime / audioEl.duration) * 100;
            seekSlider.style.background = `linear-gradient(to right, var(--primary) ${progressPercent}%, #eef2ff ${progressPercent}%)`;
        });

        seekSlider.addEventListener('input', () => { audioEl.currentTime = seekSlider.value; });
        rewindBtn.addEventListener('click', () => { audioEl.currentTime = Math.max(0, audioEl.currentTime - 10); });
        forwardBtn.addEventListener('click', () => { audioEl.currentTime = Math.min(audioEl.duration, audioEl.currentTime + 10); });
    }

    function displayAudioSolution() {
        const container = document.getElementById('audioSolutionContainer');
        const playerDiv = document.getElementById('audioSolutionPlayer');
        if (currentTestDetails.solutionAudio && currentTestDetails.solutionAudio.url) {
            renderSolutionAudioPlayer(playerDiv, currentTestDetails.solutionAudio.url);
            container.classList.remove('hidden');
        } else {
            playerDiv.innerHTML = '';
            container.classList.add('hidden');
        }
    }
    
    // --- REWRITTEN/NEW FUNCTIONS FOR HIDDEN VIDEO SOLUTION ---
    function displayVideoSolution() {
        const container = document.getElementById('videoSolutionContainer');
        container.innerHTML = '';

        if (currentTestDetails.solutionVideoUrl) {
            container.classList.remove('hidden');
            container.innerHTML = `
                <h3 class="text-xl font-bold mb-4 text-red-600"> Solution</h3>
                <div class="audio-player-wrapper">
                    <div id="solution-video-custom-player" class="w-full">
                        <div class="relative">
                            <input type="range" id="solution-video-seek-slider" class="w-full h-2 bg-indigo-100 rounded-lg appearance-none cursor-pointer solution-seek-slider" value="0" step="1" style="background-size: 0% 100%;">
                        </div>
                        <div class="flex justify-between items-center text-sm text-gray-600 mt-2 font-mono">
                            <div class="flex items-center gap-3">
                                <button id="solution-video-play-pause-btn" class="text-indigo-600 hover:text-indigo-800 text-xl transition-transform transform hover:scale-110" title="Play/Pause"><i class="fas fa-play"></i></button>
                                <button id="solution-video-rewind-btn" class="text-indigo-600 hover:text-indigo-800 text-lg transition-transform transform hover:scale-110" title="Rewind 10s"><i class="fas fa-undo"></i></button>
                            </div>
                            <div class="flex items-center gap-2">
                                <span id="solution-video-current-time">0:00</span>
                                <span>/</span>
                                <span id="solution-video-duration">0:00</span>
                            </div>
                             <div class="flex items-center gap-3">
                                <button id="solution-video-forward-btn" class="text-indigo-600 hover:text-indigo-800 text-lg transition-transform transform hover:scale-110" title="Forward 10s"><i class="fas fa-redo"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="youtube-solution-player-wrapper" class="dictation-mode-hidden">
                    <div id="youtube-solution-player-div"></div>
                </div>`;
            embedSolutionVideo(currentTestDetails.solutionVideoUrl);
        } else {
            container.classList.add('hidden');
        }
    }

    async function saveAttemptToFirebase(testTitle, category, stats, comparisonHtml, originalText, userText, timestamp) {
        if (!currentUser) return;

        // Check if this is the user's first attempt for this specific test title
        const attemptsRef = database.ref('attempts');
        const snapshot = await attemptsRef.orderByChild('userId').equalTo(currentUser.uid).once('value');
        const userAttempts = snapshot.val() ? Object.values(snapshot.val()) : [];
        const isFirstAttempt = !userAttempts.some(att => att.testTitle === testTitle);

        const dictationSpeedWPMEl = document.getElementById('dictationSpeedWPM');
        const dictationSpeed = dictationSpeedWPMEl ? dictationSpeedWPMEl.value : 'original';

        const attemptData = {
            userId: currentUser.uid,
            userName: currentUser.displayName || 'User',
            userPhoto: currentUser.photoURL || `https://www.gravatar.com/avatar/${currentUser.uid}?d=identicon&s=30`,
            testTitle,
            category,
            stats,
            comparisonHtml,
            originalText,
            userText,
            timestamp: timestamp || firebase.database.ServerValue.TIMESTAMP,
            dictationSpeed: dictationSpeed,
            isFirstAttempt: isFirstAttempt,
            config: transcriptionConfig // Save the config used for this attempt
        };
        const newAttemptRef = await database.ref('attempts').push(attemptData);
        attemptData.id = newAttemptRef.key;
        allLeaderboardAttempts.push(attemptData); // Also update live leaderboard data
    }
    function downloadAsPdf() {
        if (!jsPDF || !window.html2canvas) { showToast("PDF generation library is not loaded yet. Please try again in a moment.", "error"); return; }
        const resultsElement = document.getElementById('results'); const contentToCapture = resultsElement.querySelector('.max-w-4xl');
        const clone = contentToCapture.cloneNode(true); 
        clone.querySelectorAll('.add-to-practice-btn').forEach(btn => btn.remove());
        clone.querySelectorAll('audio').forEach(audio => audio.remove());
        const header = document.createElement('div'); header.className = 'p-4 mb-6 bg-white rounded-lg shadow-md';
        const userName = currentUser ? currentUser.displayName : "Guest";
        const displayTitle = currentTestDetails.title || "Custom Test";
        header.innerHTML = `<div class="text-center"><h1 class="text-2xl font-bold text-indigo-700">${displayTitle}</h1><p class="text-md text-gray-700 mt-1">Result for: <span class="font-semibold">${userName}</span></p></div>`;
        clone.insertBefore(header, clone.firstChild);
        const cloneContainer = document.createElement('div');
        cloneContainer.style.position = 'absolute'; cloneContainer.style.left = '-9999px'; cloneContainer.style.top = '0px'; cloneContainer.style.width = '1024px'; cloneContainer.style.height = 'auto';
        cloneContainer.appendChild(clone); document.body.appendChild(cloneContainer);
        const canvasOptions = { scale: 2, useCORS: true, backgroundColor: '#f8f9fa' };
        window.html2canvas(clone, canvasOptions).then(canvas => {
            document.body.removeChild(cloneContainer);
            const imgData = canvas.toDataURL('image/jpeg', 0.9);
            const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            const pdfWidth = pdf.internal.pageSize.getWidth(); const pdfHeight = pdf.internal.pageSize.getHeight();
            const canvasWidth = canvas.width; const canvasHeight = canvas.height;
            const imgHeight = canvasHeight * pdfWidth / canvasWidth;
            let heightLeft = imgHeight; let position = 0;
            pdf.addImage(imgData, 'JPEG', 0, position, pdfWidth, imgHeight);
            heightLeft -= pdfHeight;
            while (heightLeft > 0) {
                position -= pdfHeight; pdf.addPage();
                pdf.addImage(imgData, 'JPEG', 0, position, pdfWidth, imgHeight);
                heightLeft -= pdfHeight;
            }
            const safeTestTitle = currentTestDetails.title.replace(/[^a-zA-Z0-9]/g, '_');
            const safeUserName = userName.replace(/[^a-zA-Z0-9]/g, '_');
            pdf.save(`Stenomania_${safeTestTitle}_${safeUserName}.pdf`);
        });
    }
    function processText(text) { return text.replace(/<[^>]*>/g, '').replace(/[\u2018\u2019]/g, "'").replace(/[\u201C\u201D]/g, '"').trim().split(/\s+/).filter(word => word.length > 0); }
    function getWordBase(word, keepPunctuation = false) { if (!word) return ""; return keepPunctuation ? word : word.replace(/[.,]$/, ''); }
    function getLcsTable(arr1, arr2) {
        const m = arr1.length; const n = arr2.length;
        const dp = Array(m + 1).fill(0).map(() => Array(n + 1).fill(0));
        for (let i = 1; i <= m; i++) {
            for (let j = 1; j <= n; j++) {
                if (getWordBase(arr1[i - 1]).toLowerCase() === getWordBase(arr2[j - 1]).toLowerCase()) { dp[i][j] = dp[i - 1][j - 1] + 1; } 
                else { dp[i][j] = Math.max(dp[i - 1][j], dp[i][j - 1]); }
            }
        }
        return dp;
    }
    function levenshtein(s1, s2) {
        if (s1.length < s2.length) { return levenshtein(s2, s1); }
        if (s2.length === 0) { return s1.length; }
        let previousRow = Array.from({ length: s2.length + 1 }, (_, i) => i);
        for (let i = 0; i < s1.length; i++) {
            let currentRow = [i + 1];
            for (let j = 0; j < s2.length; j++) {
                let insertions = previousRow[j + 1] + 1;
                let deletions = currentRow[j] + 1;
                let substitutions = previousRow[j] + (s1[i] !== s2[j]);
                currentRow.push(Math.min(insertions, deletions, substitutions));
            }
            previousRow = currentRow;
        }
        return previousRow[s2.length];
    }
    function findBestMatchIndex(originalWords, userWords) {
        if (!userWords.length || !originalWords.length) { return 0; }
        let bestIndex = 0; let bestScore = -1;
        const maxPossibleIndex = originalWords.length - userWords.length;
        for (let i = 0; i <= Math.max(0, maxPossibleIndex); i++) {
            let currentScore = 0;
            for (let j = 0; j < userWords.length; j++) { if (originalWords[i + j] && getWordBase(originalWords[i + j]).toLowerCase() === getWordBase(userWords[j]).toLowerCase()) { currentScore++; } }
            if (currentScore > bestScore) { bestScore = currentScore; bestIndex = i; }
        }
        if ((bestScore / userWords.length) < 0.1) { return 0; }
        return bestIndex;
    }
    function compareParagraphsLCS(originalWords, userWords) {
        let comparisonOriginalSegment = originalWords;
        let comparisonUserSegment = userWords;
        const lcsTable = getLcsTable(comparisonOriginalSegment, comparisonUserSegment);
        let i = comparisonOriginalSegment.length;
        let j = comparisonUserSegment.length;
        const rawDiffResult = [];
        while (i > 0 || j > 0) {
            const origWord = i > 0 ? comparisonOriginalSegment[i - 1] : ''; 
            const userWord = j > 0 ? comparisonUserSegment[j - 1] : '';
            const origBase = getWordBase(origWord); 
            const userBase = getWordBase(userWord);
            const origPunc = getWordBase(origWord, true); 
            const userPunc = getWordBase(userWord, true);
            if (i > 0 && j > 0 && origBase.toLowerCase() === userBase.toLowerCase()) {
                if (origBase !== userBase) { rawDiffResult.push({ type: 'capitalization', originalWord: origWord, userWord: userWord }); } 
                else if (origPunc !== userPunc) { rawDiffResult.push({ type: 'punctuation', originalWord: origWord, userWord: userWord }); } 
                else { rawDiffResult.push({ type: 'correct', word: origWord }); }
                i--; j--;
            } else if (j > 0 && (i === 0 || lcsTable[i][j - 1] >= lcsTable[i - 1][j])) { rawDiffResult.push({ type: 'addition', word: userWord }); j--; } 
            else if (i > 0 && (j === 0 || lcsTable[i][j - 1] < lcsTable[i - 1][j])) { rawDiffResult.push({ type: 'missing', word: origWord }); i--; } 
            else { break; }
        }
        rawDiffResult.reverse();
        const processedResult = [];
        const SPELLING_LOOKAHEAD_WINDOW = 5; 
        const isConsumed = new Array(rawDiffResult.length).fill(false);
        for (let k = 0; k < rawDiffResult.length; k++) {
            if (isConsumed[k]) continue;
            const current = rawDiffResult[k];
            let matchFound = false;
            if (current.type === 'missing') {
                for (let l = 1; l <= SPELLING_LOOKAHEAD_WINDOW && (k + l) < rawDiffResult.length; l++) {
                    const lookahead = rawDiffResult[k + l];
                    if (!isConsumed[k + l] && lookahead.type === 'addition') {
                        const missingWord = current.word;
                        const addedWord = lookahead.word;
                        const distance = levenshtein(getWordBase(missingWord).toLowerCase(), getWordBase(addedWord).toLowerCase());
                        const threshold = getWordBase(missingWord).length > 4 ? 2 : 1;
                        if (distance <= threshold) {
                            processedResult.push({ type: 'spelling-error', originalWord: missingWord, userWord: addedWord });
                            isConsumed[k] = true;
                            isConsumed[k + l] = true;
                            matchFound = true;
                            break;
                        }
                    }
                }
            }
            if (!matchFound) { processedResult.push(current); }
        }
        let capitalizationMistakes = 0, punctuationMistakes = 0, additionCount = 0, missingCount = 0, spellingMistakes = 0, correctCount = 0;
        let html = '';
        processedResult.forEach(diff => {
            const practiceButtonHTML = (wordForPractice) => {
                const base = getWordBase(wordForPractice);
                if (!base) return '';
                const isDisabled = practiceWords.has(base);
                const iconClass = isDisabled ? 'fas fa-check-circle' : 'fas fa-plus';
                return `<button class="add-to-practice-btn" data-word="${base}" title="Add '${base}' to practice list" ${isDisabled ? 'disabled' : ''}><i class="${iconClass}"></i></button>`;
            };
            switch (diff.type) {
                case 'correct': correctCount++; html += `<span class="correct explainable-word" data-word="${getWordBase(diff.word)}">${diff.word}</span> `; break;
                case 'spelling-error': spellingMistakes++; const userTypo = diff.userWord; const correctWord = diff.originalWord; html += `<span class="mistake-word-container"><span class="spelling-mistake-wrapper explainable-word" data-word="${getWordBase(correctWord)}"><span class="incorrect-word">${userTypo}</span> <span class="correct-word-suggestion">${correctWord}</span></span>${practiceButtonHTML(correctWord)}</span> `; break;
                case 'capitalization': capitalizationMistakes++; html += `<span class="mistake-word-container"><span class="capitalization explainable-word" data-word="${getWordBase(diff.originalWord)}">${diff.originalWord}</span>${practiceButtonHTML(diff.originalWord)}</span> `; break;
                case 'punctuation': punctuationMistakes++; html += `<span class="mistake-word-container"><span class="punctuation explainable-word" data-word="${getWordBase(diff.originalWord)}">${diff.originalWord}</span>${practiceButtonHTML(diff.originalWord)}</span> `; break;
                case 'missing': missingCount++; html += `<span class="mistake-word-container"><span class="missing explainable-word" data-word="${getWordBase(diff.word)}">${diff.word}</span>${practiceButtonHTML(diff.word)}</span> `; break;
                case 'addition': additionCount++; html += `<span class="mistake-word-container"><span class="addition explainable-word" data-word="${getWordBase(diff.word)}">${diff.word}</span>${practiceButtonHTML(diff.word)}</span> `; break;
            }
        });
        
        // MODIFIED: Calculate total mistakes based on config weights
        const totalMistakes = (additionCount * 1) + 
                              (missingCount * 1) + 
                              (spellingMistakes * transcriptionConfig.spellingWeight) +
                              (capitalizationMistakes * transcriptionConfig.capitalizationWeight) + 
                              (punctuationMistakes * transcriptionConfig.punctuationWeight);

        const totalOrigFull = originalWords.length;
        const totalWordsCompared = comparisonOriginalSegment.length;
        let accuracy;
        accuracy = totalOrigFull > 0 ? ((totalOrigFull - totalMistakes) / totalOrigFull) * 100 : (userWords.length === 0 ? 100 : 0);
        accuracy = Math.max(0, accuracy);
        const timeTakenVal = startTime ? Math.round((new Date() - startTime) / 1000) : 0;
        const timeMins = timeTakenVal / 60;
        const wpmVal = timeMins > 0 ? Math.round(userWords.length / timeMins) : 0;
        return { html: html.trim(), stats: { totalOriginal: totalOrigFull, totalUser: userWords.length, totalMistakes: totalMistakes, keystrokes: userTextEl ? userTextEl.value.length : 0, missingWords: missingCount, addedWords: additionCount, wpm: wpmVal, accuracy: accuracy, timeTaken: timeTakenVal, punctuationMistakes: punctuationMistakes, capitalizationMistakes: capitalizationMistakes, spellingMistakes: spellingMistakes, totalWordsCompared: totalWordsCompared } };
    }
    function displayComparison(comparison) { comparisonResultEl.innerHTML = comparison.html; }
    
    function displayAppliedRules(config) {
        const appliedRulesContainer = document.getElementById('appliedRulesContainer');
        const appliedRulesText = document.getElementById('appliedRulesText');
        
        if (!config || !appliedRulesContainer || !appliedRulesText) {
            if(appliedRulesContainer) appliedRulesContainer.classList.add('hidden');
            return;
        }

        const weightToText = (weight) => {
            if (weight === 1) return "Full";
            if (weight === 0.5) return "Half";
            return "None";
        };

        const rules = [
            `Spelling (${weightToText(config.spellingWeight)})`,
            `Capitalization (${weightToText(config.capitalizationWeight)})`,
            `Punctuation (${weightToText(config.punctuationWeight)})`
        ];

        appliedRulesText.textContent = rules.join(' | ');
        appliedRulesContainer.classList.remove('hidden');
    }

    function displayStats(stats, timestamp) {
        statsEl.innerHTML = `<div class="card p-4 rounded-lg text-center"><p class="text-sm font-semibold text-gray-500">Accuracy</p><p class="text-3xl font-bold text-green-500">${stats.accuracy.toFixed(1)}%</p></div><div class="card p-4 rounded-lg text-center"><p class="text-sm font-semibold text-gray-500">WPM</p><p class="text-3xl font-bold text-indigo-500">${stats.wpm}</p></div><div class="card p-4 rounded-lg text-center"><p class="text-sm font-semibold text-gray-500">Mistakes</p><p class="text-3xl font-bold text-red-500">${stats.totalMistakes.toFixed(1)}</p></div><div class="card p-4 rounded-lg text-center"><p class="text-sm font-semibold text-gray-500">Time</p><p class="text-3xl font-bold">${Math.floor(stats.timeTaken / 60)}:${(stats.timeTaken % 60).toString().padStart(2, '0')}</p></div>`;
        moreStatsEl.innerHTML = `<div class="card p-4 rounded-lg text-center"><p class="text-sm font-semibold text-gray-500">Original Words</p><p class="text-3xl font-bold">${stats.totalOriginal}</p></div><div class="card p-4 rounded-lg text-center"><p class="text-sm font-semibold text-gray-500">Typed Words</p><p class="text-3xl font-bold">${stats.totalUser}</p></div><div class="card p-4 rounded-lg text-center"><p class="text-sm font-semibold text-gray-500">Missing Words</p><p class="text-3xl font-bold text-red-500">${stats.missingWords}</p></div><div class="card p-4 rounded-lg text-center"><p class="text-sm font-semibold text-gray-500">Added Words</p><p class="text-3xl font-bold text-blue-500">${stats.addedWords}</p></div>`;
        resultTimestampEl.textContent = `Completed on: ${formatDateTime(timestamp)}`;
        resultModeTag.textContent = '';
    }
    function displayFeedback(stats) {
        let fb = `<h3 class="text-xl font-bold mb-4">Feedback</h3> <h4 class="font-semibold text-lg mb-2">Overall Assessment</h4> ${getOverallAssessment(stats.accuracy, stats.wpm)} <h4 class="font-semibold text-lg mt-4 mb-2">Mistake Summary</h4><ul class="list-disc list-inside space-y-1">`;
        if (stats.totalMistakes > 0) { fb += `<li>Found <strong>${stats.totalMistakes.toFixed(1)} calculated mistake(s)</strong> affecting accuracy.</li>`; if (stats.spellingMistakes > 0) fb += `<li>${stats.spellingMistakes} word(s) were likely misspelled (1 mistake each).</li>`; if (stats.missingWords > 0) fb += `<li>${stats.missingWords} word(s) were missed (1 mistake each).</li>`; if (stats.addedWords > 0) fb += `<li>${stats.addedWords} word(s) were added (1 mistake each).</li>`; if (stats.capitalizationMistakes > 0) fb += `<li>${stats.capitalizationMistakes} capitalization difference(s) (1 mistake each).</li>`; if (stats.punctuationMistakes > 0) fb += `<li>${stats.punctuationMistakes} punctuation difference(s) (1 mistake each).</li>`; } else { fb += `<li>No mistakes found! Excellent work!</li>`; }
        fb += `</ul>`; feedbackEl.innerHTML = fb;
    }
    function displayFullTexts(original, user) { originalDisplayEl.textContent = original; if(userDisplayEl) userDisplayEl.textContent = user; }
    function getOverallAssessment(accuracy, wpm) {
        let a = '';
        if (accuracy >= 98) a += '<p class="text-green-600 font-medium">ðŸŒŸ Outstanding accuracy!</p>';
        else if (accuracy >= 95) a += '<p class="text-green-600 font-medium">ðŸ‘ Excellent accuracy!</p>';
        else if (accuracy >= 90) a += '<p>âœ… Good accuracy.</p>';
        else a += '<p class="text-yellow-600 font-medium">ðŸ“ Fair accuracy, keep practicing.</p>';
        if (wpm >= 60) a += '<p class="text-indigo-600 font-medium">âš¡ Very Fast Typer!</p>';
        else if (wpm >= 40) a += '<p class="font-medium">ðŸš€ Fast Typer!</p>';
        else a += '<p class="font-medium">ðŸƒ Good speed, consistency is key.</p>';
        return a;
    }
    const wordActionPopover = document.getElementById('wordActionPopover');
    const popoverAddBtn = document.getElementById('popoverAddBtn');
    const popoverExplainBtn = document.getElementById('popoverExplainBtn');
    function hidePopover() { wordActionPopover.classList.add('hidden'); }
    comparisonResultEl.addEventListener('click', (e) => {
        const addBtn = e.target.closest('.add-to-practice-btn');
        if (addBtn && !addBtn.disabled) { e.stopPropagation(); const word = addBtn.dataset.word; addWordToPractice(word, addBtn); return; }
        const wordSpan = e.target.closest('.explainable-word');
        if (wordSpan) {
            const baseWord = wordSpan.dataset.word;
            if (isTouchDevice && wordSpan.parentElement.classList.contains('mistake-word-container')) {
                e.preventDefault();
                hidePopover();
                const rect = wordSpan.getBoundingClientRect();
                wordActionPopover.style.top = `${window.scrollY + rect.top - wordActionPopover.offsetHeight - 8}px`;
                wordActionPopover.style.left = `${window.scrollX + rect.left + (rect.width / 2) - (wordActionPopover.offsetWidth / 2)}px`;
                popoverAddBtn.dataset.word = baseWord;
                popoverExplainBtn.dataset.word = baseWord;
                popoverAddBtn.disabled = practiceWords.has(baseWord);
                wordActionPopover.classList.remove('hidden');
            } else {
                getWordExplanation(baseWord);
            }
        }
    });
    popoverAddBtn.addEventListener('click', (e) => { const word = e.currentTarget.dataset.word; const originalButton = comparisonResultEl.querySelector(`.add-to-practice-btn[data-word="${word}"]`); addWordToPractice(word, originalButton); e.currentTarget.disabled = true; setTimeout(hidePopover, 200); });
    popoverExplainBtn.addEventListener('click', (e) => { getWordExplanation(e.currentTarget.dataset.word); hidePopover(); });
    document.addEventListener('click', (e) => { if (!wordActionPopover.classList.contains('hidden') && !e.target.closest('#wordActionPopover') && !e.target.closest('.explainable-word')) { hidePopover(); } });
    
    async function getWordExplanation(baseWord) {
        const modal = document.getElementById('explainModal');
        const modalContent = document.getElementById('explainModalContent');
        modalContent.innerHTML = `<div class="flex justify-center items-center py-8"><i class="fas fa-spinner fa-spin text-2xl text-indigo-500 mr-3"></i><span class="text-indigo-700 font-medium">Looking up definition for: "${baseWord}"</span></div>`;
        modal.classList.remove('hidden');

        try {
            const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${baseWord}`);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.title || `Could not find a definition.`);
            }
            const data = await response.json();
            const wordData = data[0];
            
            const phoneticAudio = wordData.phonetics.find(p => p.audio)?.audio;
            const phoneticText = wordData.phonetic || wordData.phonetics.find(p => p.text)?.text || '';

            let headerHTML = `<div class="flex items-center gap-4 mb-4">
                                <h4 class="font-bold text-3xl text-indigo-800 capitalize">${wordData.word}</h4>
                                <span class="text-gray-500">${phoneticText}</span>`;
            if (phoneticAudio) {
                headerHTML += `<button onclick="document.getElementById('wordAudio').play()" class="btn text-indigo-500 hover:text-indigo-700"><i class="fas fa-volume-up"></i></button>
                               <audio id="wordAudio" src="${phoneticAudio}"></audio>`;
            }
            headerHTML += `</div>`;

            let meaningsHTML = wordData.meanings.map(meaning => {
                let definitionsHTML = meaning.definitions.map((def, index) => `
                    <li class="mb-3">
                        <p class="text-gray-800">${def.definition}</p>
                        ${def.example ? `<p class="text-gray-500 italic mt-1 pl-4 border-l-2">"${def.example}"</p>` : ''}
                    </li>
                `).join('');

                return `<div class="mt-4">
                            <h5 class="font-bold text-lg text-gray-700 italic">${meaning.partOfSpeech}</h5>
                            <ol class="list-decimal list-inside mt-2 pl-2">${definitionsHTML}</ol>
                        </div>`;
            }).join('');

            const allSynonyms = [...new Set(wordData.meanings.flatMap(m => m.definitions.flatMap(d => d.synonyms || [])))];
            const allAntonyms = [...new Set(wordData.meanings.flatMap(m => m.definitions.flatMap(d => d.antonyms || [])))];
            
            const synonymsHTML = allSynonyms.length > 0 
                ? `<div class="info-section"><h5><i class="fas fa-comments"></i> Synonyms</h5><div>${allSynonyms.map(s => `<span class="info-chip">${s}</span>`).join('')}</div></div>` 
                : '';
            const antonymsHTML = allAntonyms.length > 0 
                ? `<div class="info-section"><h5><i class="fas fa-comment-slash"></i> Antonyms</h5><div>${allAntonyms.map(a => `<span class="info-chip">${a}</span>`).join('')}</div></div>` 
                : '';

            modalContent.innerHTML = headerHTML + meaningsHTML + synonymsHTML + antonymsHTML;

        } catch (error) {
            console.error('Dictionary API Error:', error);
            modalContent.innerHTML = `<h4 class="font-bold text-lg mb-2 text-red-700">Error</h4><p class="text-red-600 p-4 bg-red-50 rounded-lg"><strong>${error.message}</strong> for the word "<strong>${baseWord}</strong>". Please try another word.</p>`;
        }
    }
    
    async function loadPracticeWordsFromFirebase() {
        if (!currentUser) { practiceWords = new Set(); updatePracticeUI(); return; }
        const practiceWordsRef = database.ref(`users/${currentUser.uid}/practiceWords`);
        try { const snapshot = await practiceWordsRef.once('value'); if (snapshot.exists()) { const data = snapshot.val(); practiceWords = new Set(Object.keys(data)); } else { practiceWords = new Set(); } } catch (e) { console.error("Could not load practice words from Firebase:", e); practiceWords = new Set(); }
        updatePracticeUI();
    }
    function addWordToPractice(word, buttonElement) {
        if (!currentUser) return;
        database.ref(`users/${currentUser.uid}/practiceWords/${word}`).set(true);
        practiceWords.add(word); 
        if (buttonElement) { buttonElement.disabled = true; const icon = buttonElement.querySelector('i'); if (icon) { icon.className = 'fas fa-check-circle'; } }
        const popoverBtn = document.getElementById('popoverAddBtn');
        if (popoverBtn && popoverBtn.dataset.word === word) { popoverBtn.disabled = true; }
        updatePracticeUI();
        showToast(`'${word}' added to practice list.`, 'success');
    }
    manualAddWordBtn.addEventListener('click', () => {
        if (!currentUser) return;
        const text = manualAddWordInput.value.trim();
        if (!text) return;
        const wordsToAdd = text.split(/[\s,]+/).filter(Boolean);
        const updates = {};
        wordsToAdd.forEach(word => { updates[word] = true; practiceWords.add(word); });
        database.ref(`users/${currentUser.uid}/practiceWords`).update(updates);
        updatePracticeUI();
        manualAddWordInput.value = '';
    });
    clearPracticeListBtn.addEventListener('click', () => {
        if (!currentUser) return;
        if (confirm('Are you sure you want to clear your entire practice list? This will be removed from your online account.')) {
            database.ref(`users/${currentUser.uid}/practiceWords`).remove();
            practiceWords.clear();
            updatePracticeUI();
            comparisonResultEl.querySelectorAll('.add-to-practice-btn').forEach(btn => {
                btn.disabled = false; 
                const icon = btn.querySelector('i');
                if (icon) icon.className = 'fas fa-plus';
            });
            showToast("Practice list cleared.", "success");
        }
    });
    practiceWordChipInner.addEventListener('click', e => {
        const removeBtn = e.target.closest('.remove-practice-word-btn');
        if (removeBtn) {
            if (!currentUser) return;
            const wordToRemove = removeBtn.dataset.wordToRemove;
            database.ref(`users/${currentUser.uid}/practiceWords/${wordToRemove}`).remove();
            practiceWords.delete(wordToRemove);
            const mainViewBtn = comparisonResultEl.querySelector(`.add-to-practice-btn[data-word="${wordToRemove}"]`);
            if (mainViewBtn) { mainViewBtn.disabled = false; const icon = mainViewBtn.querySelector('i'); if(icon) icon.className = 'fas fa-plus'; }
            updatePracticeUI();
        }
    });
    function updatePracticeUI() {
        const count = practiceWords.size;
        const progressButton = document.getElementById('practiceMistakesBtnProgress');
        const progressBadge = document.getElementById('practiceWordCountBadgeProgress');
        if (progressButton && progressBadge) { if (count > 0) { progressButton.classList.remove('hidden'); progressBadge.textContent = count; } else { progressButton.classList.add('hidden'); } }
        practiceWordChipInner.innerHTML = '';
        if (count === 0) {
            practiceWordChipInner.innerHTML = `<p class="w-full text-center text-gray-500 py-10">Your practice list is empty. Add mistaken words from your results.</p>`;
            startPracticeSessionBtn.disabled = true; printPracticeWordsBtn.disabled = true;
        } else {
            const reversedWords = Array.from(practiceWords).reverse();
            reversedWords.forEach(word => { const chip = document.createElement('div'); chip.className = 'inline-flex items-center gap-2 bg-indigo-100 text-indigo-800 text-sm font-medium px-3 py-1.5 rounded-full'; chip.innerHTML = `<span>${word}</span><button data-word-to-remove="${word}" class="remove-practice-word-btn text-indigo-400 hover:text-indigo-600"><i class="fas fa-times-circle"></i></button>`; practiceWordChipInner.appendChild(chip); });
            startPracticeSessionBtn.disabled = false; printPracticeWordsBtn.disabled = false;
        }
    }
    document.body.addEventListener('click', (e) => { const practiceBtn = e.target.closest('#practiceMistakesBtnProgress'); if (practiceBtn) { practiceSetupView.classList.remove('hidden'); practiceSessionView.classList.add('hidden'); updatePracticeUI(); typingPracticeModal.classList.remove('hidden'); document.body.style.overflow = 'hidden'; } });
    closePracticeModalBtn.addEventListener('click', () => { typingPracticeModal.classList.add('hidden'); document.body.style.overflow = ''; });
    repetitionCountInput.addEventListener('input', () => { repetitionCountDisplay.textContent = repetitionCountInput.value || 1; });
    printPracticeWordsBtn.addEventListener('click', () => { if (practiceWords.size === 0) { showToast("Your practice list is empty.", "error"); return; } if (!jsPDF) { showToast("PDF library not loaded yet. Please wait.", "error"); return; } const pdf = new jsPDF(); const words = Array.from(practiceWords).reverse(); const date = new Date().toLocaleDateString(); pdf.setFont("helvetica", "bold"); pdf.setFontSize(18); pdf.text("Stenomania Dictations - Practice Words", 105, 15, null, null, "center"); pdf.setFont("helvetica", "normal"); pdf.setFontSize(10); pdf.text(`Generated on: ${date} | Total Words: ${words.length}`, 105, 22, null, null, "center"); pdf.setFont("courier", "normal"); pdf.setFontSize(12); const pageHeight = pdf.internal.pageSize.height; const colWidth = 65, startX = 15, startY = 35; let x = startX, y = startY, col = 0; words.forEach(word => { if (y > pageHeight - 15) { col++; y = startY; x = startX + (col * colWidth); if (col > 2) { pdf.addPage(); col = 0; x = startX; y = startY; } } pdf.text(word, x, y); y += 8; }); pdf.save("Steno_Warriors_Practice_Words.pdf"); });
    startPracticeSessionBtn.addEventListener('click', () => { const wordsToPractice = Array.from(practiceWords).reverse(); if (wordsToPractice.length === 0) return; const reps = parseInt(repetitionCountInput.value, 10) || 5; if (reps < 1 || reps > 20) { showToast("Please enter a repetition count between 1 and 20.", "error"); return; } const repeatedWords = wordsToPractice.flatMap(w => Array(reps).fill(w)); practiceSessionState.words = repeatedWords; practiceSessionState.currentIndex = 0; practiceTextDisplay.innerHTML = repeatedWords.map((word, index) => `<div class="word" data-word-index="${index}">${word.split('').map(letter => `<span class="letter">${letter}</span>`).join('')}</div>`).join(''); practiceTextInput.value = ''; practiceTextInput.readOnly = false; practiceSetupView.classList.add('hidden'); practiceSessionView.classList.remove('hidden'); updateCurrentWordHighlight(); practiceTextInput.focus(); });
    backToPracticeSetupBtn.addEventListener('click', () => { practiceSessionView.classList.add('hidden'); practiceSetupView.classList.remove('hidden'); });
    function updateCurrentWordHighlight() { practiceTextDisplay.querySelectorAll('.word').forEach(w => w.classList.remove('current')); const currentWordEl = practiceTextDisplay.querySelector(`.word[data-word-index="${practiceSessionState.currentIndex}"]`); if (currentWordEl) { currentWordEl.classList.add('current'); currentWordEl.scrollIntoView({ behavior: 'smooth', block: 'center' }); } }
    practiceTextInput.addEventListener('input', () => { const { words, currentIndex } = practiceSessionState; if (currentIndex >= words.length) return; const currentWord = words[currentIndex]; const typedValue = practiceTextInput.value; const currentWordEl = practiceTextDisplay.querySelector(`.word[data-word-index="${currentIndex}"]`); const letterSpans = currentWordEl.querySelectorAll('.letter'); letterSpans.forEach((span, i) => { if (i < typedValue.length) { span.className = 'letter ' + (typedValue[i] === currentWord[i] ? 'correct' : 'incorrect'); } else { span.className = 'letter'; } }); });
    practiceTextInput.addEventListener('keydown', e => { if (e.key === ' ') { e.preventDefault(); const { words, currentIndex } = practiceSessionState; if (currentIndex >= words.length) return; const currentWord = words[currentIndex]; const typedValue = practiceTextInput.value.trim(); const currentWordEl = practiceTextDisplay.querySelector(`.word[data-word-index="${currentIndex}"]`); currentWordEl.classList.remove('current'); currentWordEl.classList.add(typedValue === currentWord ? 'completed-correct' : 'completed-incorrect'); practiceSessionState.currentIndex++; if (practiceSessionState.currentIndex < words.length) { updateCurrentWordHighlight(); practiceTextInput.value = ''; } else { practiceTextInput.value = "Practice Complete!"; practiceTextInput.readOnly = true; showToast("Great work! Practice session complete.", "success"); } } });
    
    function getCategoryDisplayName(catKey) {
        const names = { 
            general: 'General Matter', 
            kailash: 'Kailash Chandra', 
            progressive: 'Progressive', 
            legal: 'Legal', 
            previous: 'Previous Year', 
            test: 'Test',
            all: 'All-Access' 
        };
        return names[catKey] || catKey.charAt(0).toUpperCase() + catKey.slice(1);
    }
    
    function showManualTestView() {
        showView('main');
        aiFeatureBanner.classList.add('hidden');
        newTestSelectionUI.classList.add('hidden');
        mainInputSection.classList.remove('hidden');
        manualModeHeader.classList.remove('hidden');
        testActionHeader.classList.add('hidden');
        originalTextGroup.classList.remove('hidden');
        originalTextEl.value = '';
        originalTextEl.placeholder = "Paste the original passage here.";
        if(userTextEl) { userTextEl.classList.add('hidden'); userTextEl.value = ''; }
        if (compareBtn) { compareBtn.classList.add('hidden'); }
        startTranscriptionBtn.classList.remove('hidden');
        if (window.player && typeof window.player.destroy === 'function') { window.player.destroy(); window.player = null; }
        videoContainer.innerHTML = '';
        videoContainer.classList.add('hidden');
        dictationControlContainer.classList.add('hidden');
        currentTestDetails = { title: "Custom Test", category: "general", videoUrl: null, solutionAudio: null, solutionVideoUrl: null, dictationAudio: null };
        mainInputSection.scrollIntoView({ behavior: 'smooth' });
    }
    function renderInitialCategoryView() {
        const testsByCategory = allFetchedTests.reduce((acc, test) => {
            const category = test.category || 'general';
            if (!acc[category]) { acc[category] = []; }
            acc[category].push(test);
            return acc;
        }, {});
        categoryGrid.innerHTML = '';
        const sortedCategories = Object.keys(testsByCategory).sort();

        const categoryStyles = {
            general: { gradient: 'from-blue-500 to-indigo-600', icon: 'fas fa-file-alt' },
            kailash: { gradient: 'from-green-500 to-emerald-600', icon: 'fas fa-book-open' },
            progressive: { gradient: 'from-purple-500 to-violet-600', icon: 'fas fa-chart-line' },
            legal: { gradient: 'from-red-500 to-rose-600', icon: 'fas fa-gavel' },
            previous: { gradient: 'from-amber-500 to-orange-600', icon: 'fas fa-history' },
            test: { gradient: 'from-sky-500 to-cyan-600', icon: 'fas fa-stopwatch' },
            default: { gradient: 'from-gray-500 to-slate-600', icon: 'fas fa-keyboard' }
        };

        sortedCategories.forEach(categoryKey => {
            const totalTests = testsByCategory[categoryKey].length;
            const style = categoryStyles[categoryKey] || categoryStyles.default;
            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl shadow-lg overflow-hidden flex flex-col transform hover:-translate-y-1.5 transition-all duration-300';
            
            const testInfoHTML = `
                <p class="flex items-center justify-center gap-2"><i class="fas fa-check-circle text-sm text-green-500"></i> ${totalTests} Dictation(s)</p>
                <p class="flex items-center justify-center gap-2"><i class="fas fa-check-circle text-sm text-green-500"></i> All Speeds Available</p>
                <p class="flex items-center justify-center gap-2"><i class="fas fa-check-circle text-sm text-green-500"></i> SSC Typing Interface</p>
            `;

            card.innerHTML = `
                <div class="p-8 bg-gradient-to-br ${style.gradient} flex items-center justify-center">
                    <i class="${style.icon} text-white text-6xl opacity-80"></i>
                </div>
                <div class="p-6 flex flex-col flex-grow text-center">
                    <h3 class="text-2xl font-bold text-gray-800">${getCategoryDisplayName(categoryKey)}</h3>
                    <div class="mt-4 mb-6 space-y-2 text-gray-600 text-sm flex-grow">
                        ${testInfoHTML}
                    </div>
                    <button data-category="${categoryKey}" class="view-all-btn mt-auto w-full btn btn-primary font-bold py-3 rounded-lg">
                        View Dictations
                    </button>
                </div>
            `;
            categoryGrid.appendChild(card);
        });
        categorySelectionView.classList.remove('hidden');
        testListView.classList.add('hidden');
        newTestSelectionUI.classList.remove('hidden');
    }
    function renderTestListView(categoryKey) { const testsForCategory = allFetchedTests.filter(t => t.category === categoryKey); const searchTerm = testListSearchInput.value.trim().toLowerCase(); let filteredTests = searchTerm ? testsForCategory.filter(t => t.title.toLowerCase().includes(searchTerm)) : testsForCategory; filteredTests.sort((a, b) => a.title.localeCompare(b.title, undefined, { numeric: true, sensitivity: 'base' })); testListTitle.innerHTML = `<span class="align-middle">${getCategoryDisplayName(categoryKey)} Dictations</span>`; testListGrid.innerHTML = ''; if (filteredTests.length === 0) { testListGrid.innerHTML = '<p class="text-center text-gray-500 col-span-full py-8">No dictations found for this search.</p>'; return; } const isAdmin = currentUser && ADMIN_EMAILS.includes(currentUser.email); filteredTests.forEach(test => { const card = document.createElement('div'); card.className = 'card rounded-lg p-4 flex flex-col relative'; const wordCount = test.text.split(/\s+/).length; const adminButtonsHTML = isAdmin ? `<div class="absolute top-2 right-2 flex gap-1"><button class="edit-test-btn btn bg-yellow-400 text-white p-2 rounded-full w-7 h-7 flex items-center justify-center hover:bg-yellow-500" data-id="${test.id}" title="Edit Test"><i class="fas fa-pencil-alt text-xs"></i></button><button class="delete-test-btn btn bg-red-500 text-white p-2 rounded-full w-7 h-7 flex items-center justify-center hover:bg-red-600" data-id="${test.id}" title="Delete Test"><i class="fas fa-trash-alt text-xs"></i></button></div>` : ''; card.innerHTML = `${adminButtonsHTML}<div class="flex-grow"><h4 class="text-lg font-bold text-gray-800 mb-3 pr-14">${test.title}</h4><div class="space-y-1 text-gray-600 text-sm"><p class="flex items-center"><i class="fas fa-file-word w-4 mr-2 text-gray-400"></i> ${wordCount} Words</p><p class="flex items-center"><i class="fas fa-running w-4 mr-2 text-gray-400"></i> All Speeds</p><p class="flex items-center font-semibold text-green-600"><i class="fas fa-check-circle w-4 mr-2"></i> Paid</p></div></div><button data-testid="${test.id}" class="take-test-btn mt-4 w-full btn btn-primary font-semibold py-2 rounded-lg">Take Test</button>`; testListGrid.appendChild(card); }); }
    categoryGrid.addEventListener('click', (e) => { const button = e.target.closest('.view-all-btn'); if (button) { const categoryKey = button.dataset.category; testListSearchInput.value = ''; testListSearchInput.dataset.currentCategory = categoryKey; renderTestListView(categoryKey); categorySelectionView.classList.add('hidden'); testListView.classList.remove('hidden'); } });
    backToCategoriesBtn.addEventListener('click', () => { testListView.classList.add('hidden'); categorySelectionView.classList.remove('hidden'); });
    testListSearchInput.addEventListener('input', () => { const categoryKey = testListSearchInput.dataset.currentCategory; if (categoryKey) { renderTestListView(categoryKey); } });
    testListGrid.addEventListener('click', async (e) => {
        const takeTestBtn = e.target.closest('.take-test-btn');
        const editBtn = e.target.closest('.edit-test-btn');
        const deleteBtn = e.target.closest('.delete-test-btn');
        if (takeTestBtn) { const testId = takeTestBtn.dataset.testid; const testData = allFetchedTests.find(t => t.id === testId); if(testData) { const passValid = await isUserPassValid(testData.category); if (passValid) { selectTest(testData); newTestSelectionUI.classList.add('hidden'); mainInputSection.classList.remove('hidden'); } } } 
        else if (editBtn) { prepareAdminFormForEdit(editBtn.dataset.id); } 
        else if (deleteBtn) { deleteTest(deleteBtn.dataset.id); }
    });
    function fetchAndDisplayGlobalTests() { database.ref('tests').orderByChild('timestamp').once('value').then(snapshot => { allFetchedTests = Object.entries(snapshot.val() || {}).map(([id, test]) => ({ id, ...test })); renderInitialCategoryView(); }).catch(error => { console.error('Error fetching tests:', error); }); }
    
    function updateDictationLengthOptions(totalWords) {
        const selector = document.getElementById('dictationLengthSelector');
        if (!selector) return;

        // Clear existing options, keeping the "Full Length" default
        selector.innerHTML = '<option value="full" selected>Full Length</option>';
        
        const options = [100, 200, 400, 800, 1000];
        options.forEach(optionCount => {
            if (optionCount < totalWords) {
                const firstOpt = document.createElement('option');
                firstOpt.value = `first-${optionCount}`;
                firstOpt.textContent = `First ${optionCount} Words`;
                selector.appendChild(firstOpt);

                const lastOpt = document.createElement('option');
                lastOpt.value = `last-${optionCount}`;
                lastOpt.textContent = `Last ${optionCount} Words`;
                selector.appendChild(lastOpt);
            }
        });
    }
    
    function selectTest(testData) {
        aiFeatureBanner.classList.add('hidden');
        originalTextEl.value = testData.text;
        currentTestDetails = { title: testData.title, category: testData.category, videoUrl: testData.videoUrl, solutionAudio: testData.solutionAudio || null, solutionVideoUrl: testData.solutionVideoUrl || null, dictationAudio: null };
        testActionHeader.classList.remove('hidden');
        manualModeHeader.classList.add('hidden');
        selectedTestTitle.textContent = testData.title;
        startTranscriptionBtn.classList.remove('hidden');
        if(userTextEl) { userTextEl.classList.add('hidden'); }
        if (compareBtn) { compareBtn.classList.add('hidden'); }
        if (window.player && typeof window.player.destroy === 'function') { window.player.destroy(); window.player = null; }
        videoContainer.innerHTML = '';
        embedAudio(null);
        currentTestDetails.dictationAudio = testData.dictationAudio || null;
        if (testData.videoUrl) { embedVideo(testData.videoUrl); } 
        else if (testData.dictationAudio && testData.dictationAudio.url) { embedAudio(testData.dictationAudio.url); } 
        else { videoContainer.classList.add('hidden'); document.getElementById('audioPlayerContainer').classList.add('hidden'); dictationControlContainer.classList.add('hidden'); }
        startTime = null;
        stopTimer();
        timerDisplay.classList.add('hidden');
        originalTextGroup.classList.add('hidden');
        mainInputSection.scrollIntoView({ behavior: 'smooth' });

        // NEW: Update word count options for the new test
        const totalWords = testData.text.split(/\s+/).filter(Boolean).length;
        const totalWordsDisplay = document.getElementById('totalWordsDisplay');
        const selector = document.getElementById('dictationLengthSelector');
        if (totalWordsDisplay) totalWordsDisplay.textContent = `(Total: ${totalWords})`;
        if (selector) selector.value = 'full';
        updateDictationLengthOptions(totalWords);
    }
    function getCategoryName(cat) { const names = { general: 'General', kailash: 'KC', progressive: 'Progressive', legal: 'Legal', previous: 'Previous Yr', test: 'Test' }; return names[cat] || cat; }
    function formatDate(timestamp) { if (!timestamp) return 'N/A'; return new Date(timestamp).toLocaleDateString('en-GB'); }
    function formatDateTime(timestamp) { if (!timestamp) return 'N/A'; return new Date(timestamp).toLocaleString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }); }
    function formatLeaderboardDate(timestamp) { if (!timestamp) return 'N/A'; return new Date(timestamp).toLocaleString('en-GB', { day: 'numeric', month: 'short', year: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true }); }
    function generateShortUserId(userId, userName) { let prefix = 'XX'; if (userName) { const parts = userName.split(' '); if (parts.length > 1 && parts[0] && parts[1]) { prefix = (parts[0][0] + parts[1][0]).toUpperCase(); } else if (parts[0] && parts[0].length >= 2) { prefix = parts[0].substring(0, 2).toUpperCase(); } } const suffix = userId.slice(-4); return `${prefix}${suffix}`; }
    async function fetchUserAttempts() { if (!currentUser) return []; try { const snapshot = await database.ref('attempts').orderByChild('userId').equalTo(currentUser.uid).once('value'); const data = snapshot.val(); return data ? Object.entries(data).map(([id, value]) => ({ ...value, id })).sort((a, b) => b.timestamp - a.timestamp) : []; } catch (error) { console.error("Error fetching user attempts from Firebase:", error); return []; } }
    async function deleteAttempt(attemptId) { if (!currentUser || !attemptId) return; try { await database.ref(`attempts/${attemptId}`).remove(); showToast("Attempt deleted successfully.", "success"); await loadUserProfileData(); } catch (error) { console.error('Error deleting attempt from Firebase:', error); showToast("Failed to delete attempt.", "error"); } }
    async function handleProfilePictureUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        if (!file.type.startsWith('image/')) { showToast("Please select an image file (e.g., JPG, PNG).", "error"); return; }
        if (file.size > 5 * 1024 * 1024) { showToast("File is too large. Please select an image under 5MB.", "error"); return; }
        const changeBtn = document.getElementById('changePhotoBtn');
        const spinner = document.getElementById('photoUploadSpinner');
        if(changeBtn) changeBtn.disabled = true;
        if(spinner) spinner.classList.remove('hidden');
        try {
            const response = await uploadToCloudinary(file, null);
            const newPhotoURL = response.secure_url;
            await currentUser.updateProfile({ photoURL: newPhotoURL });
            await database.ref(`users/${currentUser.uid}/photoURL`).set(newPhotoURL);
            const profileImg = document.getElementById('profilePagePhoto');
            if (profileImg) profileImg.src = newPhotoURL;
            if (userPhoto) userPhoto.src = newPhotoURL;
            showToast("Profile picture updated successfully!", "success");
        } catch (error) {
            console.error("Profile picture upload failed:", error);
            const errorMessage = error.message.includes('PERMISSION_DENIED') ? "Permission denied. Please check security rules." : error.message;
            showToast(`Upload failed: ${errorMessage}`, "error");
        } finally {
            if(changeBtn) changeBtn.disabled = false;
            if(spinner) spinner.classList.add('hidden');
            event.target.value = '';
        }
    }
    async function loadUserProfileData() {
        userProfileSection.innerHTML = `<div class="text-center p-8"><i class="fas fa-spinner fa-spin text-2xl text-indigo-500"></i><p class="mt-2">Loading profile...</p></div>`;
        const profilePhotoUrl = currentUser.photoURL || `https://www.gravatar.com/avatar/${currentUser.uid}?d=identicon&s=96`;
        const profileName = currentUser.displayName || 'Not Set';
        userProfileSection.innerHTML = `<div class="max-w-5xl mx-auto"><div class="card rounded-lg shadow-lg p-4 sm:p-6 mb-8"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">My Profile</h2><button id="backToMainFromProfileBtn" class="btn btn-secondary px-4 py-2 rounded-md">Back</button></div><div class="flex flex-col sm:flex-row items-center gap-6 mb-8 p-6 bg-gray-50 rounded-lg border"><div class="relative group"><img id="profilePagePhoto" src="${profilePhotoUrl}" class="w-24 h-24 rounded-full object-cover border-4 border-white shadow-lg"><button id="changePhotoBtn" class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 flex items-center justify-center rounded-full text-white text-2xl transition-all duration-300 cursor-pointer" title="Change Profile Picture"><i class="fas fa-camera opacity-0 group-hover:opacity-100 transition-opacity"></i></button><div id="photoUploadSpinner" class="hidden absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center rounded-full"><i class="fas fa-spinner fa-spin text-2xl text-indigo-500"></i></div></div><input type="file" id="profilePicInput" class="hidden" accept="image/png, image/jpeg, image/gif"><div><h3 class="text-2xl font-bold text-gray-800">${profileName}</h3><p class="text-gray-500">${currentUser.email}</p></div></div><div class="mb-8"><h3 class="text-xl font-bold mb-4">My Active Passes</h3><div id="activePassesList" class="space-y-4"><p class="text-center p-4 text-gray-500">Loading pass information...</p></div></div></div><div class="mt-8"><h3 class="text-2xl font-bold mb-4">Attempted Tests</h3><div id="profileAttemptsList" class="space-y-6"></div></div></div>`;
        document.getElementById('backToMainFromProfileBtn').addEventListener('click', () => showView('main'));
        document.getElementById('changePhotoBtn').addEventListener('click', () => document.getElementById('profilePicInput').click());
        document.getElementById('profilePicInput').addEventListener('change', handleProfilePictureUpload);
        database.ref(`users/${currentUser.uid}/testPasses`).once('value', snapshot => {
            const passesData = snapshot.val();
            const activePassesList = document.getElementById('activePassesList');
            activePassesList.innerHTML = '';
            let hasAnyActivePass = false;
            if (passesData) {
                // UPDATED: Use server-synced time for accurate calculation
                const now = new Date().getTime() + serverTimeOffset;
                for (const category in passesData) {
                    const pass = passesData[category];
                    if (pass.active && pass.expiresAt > now) {
                        hasAnyActivePass = true;
                        const daysLeft = Math.ceil((pass.expiresAt - now) / (1000 * 60 * 60 * 24));
                        const passCard = document.createElement('div');
                        passCard.className = 'card p-4 flex justify-between items-center';
                        passCard.innerHTML = `<div><h4 class="font-bold text-lg text-indigo-700">${getCategoryDisplayName(category)}</h4><p class="text-sm text-gray-600">${pass.planName || 'Active Pass'}</p><p class="text-xs text-gray-500 mt-1">Expires on: ${formatDate(pass.expiresAt)}</p></div><div class="text-center"><span class="text-2xl font-extrabold text-green-600">${daysLeft}</span><span class="block text-xs text-gray-500">days left</span></div>`;
                        activePassesList.appendChild(passCard);
                    }
                }
            }
            if (!hasAnyActivePass) { activePassesList.innerHTML = `<div class="text-center p-8 bg-gray-50 rounded-lg"><i class="fas fa-ticket-alt text-4xl text-gray-400 mb-4"></i><h4 class="font-bold text-xl">No Active Passes</h4><p class="text-gray-500">Please activate a pass to access tests.</p></div>`; }
        });

        // Event delegation for the entire profile section
        userProfileSection.addEventListener('click', (e) => {
             const viewRankBtn = e.target.closest('.view-rank-btn');
             const viewResultBtn = e.target.closest('.view-result-btn-history');
             const deleteBtn = e.target.closest('.delete-attempt-btn-history');

             if (viewRankBtn) {
                e.preventDefault();
                handleViewRankClick(viewRankBtn.dataset.title, viewRankBtn.dataset.bestAccuracy);
            }
            if (viewResultBtn) {
                e.preventDefault();
                showResultFromHistory(viewResultBtn.dataset.id);
            }
            if (deleteBtn) {
                e.preventDefault();
                const attemptId = deleteBtn.dataset.id;
                if (confirm('Are you sure you want to permanently delete this attempt? This action cannot be undone.')) {
                    deleteAttempt(attemptId);
                }
            }
        });

        const allUserAttempts = await fetchUserAttempts();
        userProfileAttemptsArray = allUserAttempts; // Save for result history lookup
        const profileAttemptsList = document.getElementById('profileAttemptsList');

        if (allUserAttempts.length === 0) {
            profileAttemptsList.innerHTML = `<div class="text-center p-8 bg-gray-50 rounded-lg"><i class="fas fa-history text-4xl text-gray-400 mb-4"></i><h4 class="font-bold text-xl">No Attempts Yet</h4><p class="text-gray-500">Your completed tests will appear here.</p></div>`;
            return;
        }

        const attemptsByTitle = allUserAttempts.reduce((acc, attempt) => {
            if (!acc[attempt.testTitle]) acc[attempt.testTitle] = [];
            acc[attempt.testTitle].push(attempt);
            return acc;
        }, {});

        for (const title in attemptsByTitle) {
            const attemptsForTitle = attemptsByTitle[title];
            attemptsForTitle.sort((a, b) => a.timestamp - b.timestamp);
            attemptsForTitle.forEach((attempt, index) => {
                attempt.attemptNumber = index + 1;
            });
        }
        
        const bestScores = {};
        allUserAttempts.forEach(att => {
            if (!bestScores[att.testTitle] || att.stats.accuracy > bestScores[att.testTitle]) {
                bestScores[att.testTitle] = att.stats.accuracy;
            }
        });

        profileAttemptsList.innerHTML = allUserAttempts.map(attempt => renderAttemptCard(attempt, bestScores[attempt.testTitle])).join('');
    }
    
    function renderAttemptCard(attempt, bestAccuracyForTest) {
        const { testTitle, timestamp, dictationSpeed, stats, id, attemptNumber } = attempt;
        const accuracy = stats?.accuracy?.toFixed(2) || '0.00';
        const wpm = stats?.wpm || 0;
        const date = new Date(timestamp).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        const totalWords = stats?.totalOriginal || 0; // Get the total words from stats

        const tagBaseClasses = "inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs sm:text-sm font-semibold";
        const dictationSpeedText = dictationSpeed === 'original' ? 'Original' : `${dictationSpeed} WPM`;

        return `
        <div class="bg-white rounded-lg shadow-sm border border-l-4 border-indigo-500 p-4 sm:p-5 relative">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4">
                <div class="flex items-center gap-4">
                    <div class="bg-indigo-100 text-indigo-600 rounded-full h-10 w-10 flex-shrink-0 flex items-center justify-center">
                        <i class="fas fa-microphone-alt"></i>
                    </div>
                    <h3 class="text-lg sm:text-xl font-bold text-gray-800">${testTitle}</h3>
                </div>
                <div class="flex items-center gap-2 flex-shrink-0 w-full sm:w-auto">
                    <button class="view-result-btn-history btn bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md font-semibold text-sm w-full" data-id="${id}">
                        <i class="fas fa-poll-h mr-2"></i>View Result
                    </button>
                    <button class="delete-attempt-btn-history btn bg-red-100 text-red-700 hover:bg-red-200 px-3 py-2 rounded-md font-semibold text-sm" data-id="${id}" title="Delete Attempt">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-2 sm:grid-cols-4 gap-x-4 gap-y-3 text-sm text-gray-600 border-t border-gray-200 pt-4 mb-4">
                <div class="flex items-center gap-2"><i class="fas fa-hashtag w-4 text-gray-400"></i><div><strong>Attempt:</strong> <span class="font-semibold text-gray-900">${attemptNumber}</span></div></div>
                <div class="flex items-center gap-2"><i class="fas fa-calendar-alt w-4 text-gray-400"></i><div><strong>Date:</strong> <span class="font-semibold text-gray-900">${date}</span></div></div>
                <div class="flex items-center gap-2"><i class="fas fa-tachometer-alt w-4 text-gray-400"></i><div><strong>Speed:</strong> <span class="font-semibold text-gray-900">${dictationSpeedText}</span></div></div>
                <div class="flex items-center gap-2"><i class="fas fa-trophy w-4 text-gray-400"></i><div><strong>Rank:</strong> <a href="#" class="view-rank-btn text-indigo-600 hover:underline font-semibold" data-title="${testTitle}" data-best-accuracy="${bestAccuracyForTest}">View Rank</a></div></div>
            </div>

            <div class="flex flex-wrap items-center gap-2">
                <span class="${tagBaseClasses} bg-green-100 text-green-800"><i class="fas fa-bullseye"></i> Accuracy ${accuracy}%</span>
                <span class="${tagBaseClasses} bg-purple-100 text-purple-800"><i class="fas fa-keyboard"></i> Speed: ${wpm} WPM</span>
                <span class="${tagBaseClasses} bg-gray-200 text-gray-800"><i class="fas fa-text-width"></i> Word Length: ${totalWords}</span>
            </div>
        </div>
        `;
    }

    async function handleViewRankClick(testTitle, userBestAccuracy) {
        rankModal.classList.remove('hidden');
        rankModalContent.innerHTML = `<div class="flex flex-col items-center justify-center gap-3"><i class="fas fa-spinner fa-spin text-3xl text-indigo-500"></i><p class="text-gray-600">Calculating rank...</p></div>`;
        
        try {
            const attemptsRef = database.ref('attempts');
            const snapshot = await attemptsRef.orderByChild('testTitle').equalTo(testTitle).once('value');
            const allAttemptsForTest = snapshot.val() ? Object.values(snapshot.val()) : [];

            if (allAttemptsForTest.length === 0) {
                rankModalContent.innerHTML = `<p class="text-lg">No other attempts for this test yet. You are <strong class="text-2xl text-green-600">#1</strong>!</p>`;
                return;
            }
            
            const userBests = {};
            allAttemptsForTest.forEach(att => {
                if (!userBests[att.userId] || att.stats.accuracy > userBests[att.userId]) {
                    userBests[att.userId] = att.stats.accuracy;
                }
            });

            const sortedScores = Object.values(userBests).sort((a, b) => b - a);
            // Use a tolerance for floating point comparison
            const rank = sortedScores.findIndex(score => Math.abs(score - parseFloat(userBestAccuracy)) < 0.001) + 1;
            
            if (rank > 0) {
                rankModalContent.innerHTML = `<p class="text-gray-700 text-lg">Your rank in this test is</p><p class="text-5xl font-extrabold text-indigo-600 my-2">${rank}</p>`;
            } else {
                rankModalContent.innerHTML = `<p class="text-red-500">Could not determine your rank.</p>`;
            }
        } catch (error) {
            console.error("Rank calculation error:", error);
            rankModalContent.innerHTML = `<p class="text-red-500">Error calculating rank.</p>`;
        }
    }

    closeRankModal.addEventListener('click', () => rankModal.classList.add('hidden'));


    function showResultFromHistory(attemptId) {
        const attempt = userProfileAttemptsArray.find(a => a.id === attemptId);
        if (!attempt) { showToast('Could not find the selected attempt.', 'error'); return; }
        const originalTest = allFetchedTests.find(t => t.title === attempt.testTitle);
        currentTestDetails = { title: attempt.testTitle, category: attempt.category, videoUrl: null, solutionAudio: originalTest ? originalTest.solutionAudio : null, solutionVideoUrl: originalTest ? originalTest.solutionVideoUrl : null };
        
        displayAppliedRules(attempt.config);
        displayStats(attempt.stats, attempt.timestamp);
        comparisonResultEl.innerHTML = attempt.comparisonHtml;
        displayFeedback(attempt.stats);
        displayFullTexts(attempt.originalText, attempt.userText);
        displayAudioSolution(); 
        displayVideoSolution();
        resultsSection.classList.remove('hidden');
    }

    async function loadUserProgressData() {
        if (!currentUser) return;
        progressSection.innerHTML = `<div class="text-center p-8"><i class="fas fa-spinner fa-spin text-2xl text-indigo-500"></i><p class="mt-2">Loading dashboard...</p></div>`;

        const userAttempts = await fetchUserAttempts();

        // --- Calculate Stats ---
        const totalAttempts = userAttempts.length;
        
        const last10Attempts = userAttempts.slice(0, 10);
        const avgAccuracyLast10 = last10Attempts.length > 0
            ? last10Attempts.reduce((sum, att) => sum + att.stats.accuracy, 0) / last10Attempts.length
            : 0;

        const statsHTML = `
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Rank Card -->
                <div class="bg-white rounded-xl shadow-sm p-6 flex items-center gap-5">
                    <div class="bg-purple-100 text-purple-600 rounded-lg h-12 w-12 flex-shrink-0 flex items-center justify-center">
                        <i class="fas fa-award fa-lg"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Overall Rank (30 days)</p>
                        <p id="dashboardRank" class="text-3xl font-bold text-gray-800">...</p>
                        <p class="text-xs text-gray-400">Higher avg. accuracy â†’ better rank</p>
                    </div>
                </div>
                <!-- Avg Accuracy Card -->
                <div class="bg-white rounded-xl shadow-sm p-6 flex items-center gap-5">
                    <div class="bg-green-100 text-green-600 rounded-lg h-12 w-12 flex-shrink-0 flex items-center justify-center">
                        <i class="fas fa-bullseye fa-lg"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Avg Accuracy (Last 10)</p>
                        <p id="dashboardAvgAccuracy" class="text-3xl font-bold text-gray-800">${avgAccuracyLast10.toFixed(2)}%</p>
                        <p class="text-xs text-gray-400">Recent performance</p>
                    </div>
                </div>
                <!-- Total Attempts Card -->
                <div class="bg-white rounded-xl shadow-sm p-6 flex items-center gap-5">
                    <div class="bg-yellow-100 text-yellow-600 rounded-lg h-12 w-12 flex-shrink-0 flex items-center justify-center">
                        <i class="fas fa-list-ol fa-lg"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Total Attempts</p>
                        <p id="dashboardTotalAttempts" class="text-3xl font-bold text-gray-800">${totalAttempts}</p>
                        <p class="text-xs text-gray-400">All-time tests attempted</p>
                    </div>
                </div>
            </div>`;
        
        progressSection.innerHTML = `
            <div class="card rounded-lg shadow-lg p-4 sm:p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">${currentUser.displayName || 'User'}'s Dashboard</h2>
                    <button id="backToMainFromProgressBtn" class="btn btn-secondary px-4 py-2 rounded-md">Back</button>
                </div>
                ${statsHTML}
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                    <div class="lg:col-span-3">
                        <h3 class="text-xl font-bold mb-4">Accuracy Over Time</h3>
                        <div class="h-80 bg-white rounded-xl shadow-sm p-4"><canvas id="progressChart"></canvas></div>
                    </div>
                    <div class="lg:col-span-2">
                         <h3 class="text-xl font-bold mb-4">Common Mistakes (Last 20)</h3>
                         <div class="bg-white rounded-xl shadow-sm p-4">
                            <ul id="commonMistakesList" class="text-sm space-y-2"></ul>
                         </div>
                    </div>
                    <div class="lg:col-span-5">
                        <h3 class="text-xl font-bold mb-4">Performance by Category</h3>
                        <div id="categoryPerformance" class="bg-white rounded-xl shadow-sm p-4 overflow-x-auto"></div>
                    </div>
                </div>
            </div>`;

        document.getElementById('backToMainFromProgressBtn').addEventListener('click', () => showView('main'));
        
        // --- Asynchronously calculate and update rank ---
        calculateAndDisplayOverallRank(currentUser.uid);

        // --- Render other components ---
        if (userAttempts.length === 0) {
            document.getElementById('commonMistakesList').innerHTML = `<li>No mistakes yet!</li>`;
            document.getElementById('categoryPerformance').innerHTML = `<p class="text-center p-4">No data for category analysis.</p>`;
            if (progressChartInstance) progressChartInstance.destroy();
            return;
        }

        displayCommonMistakes(userAttempts);
        displayCategoryPerformance(userAttempts);
        renderProgressChart(userAttempts.slice().reverse());
    }

    async function calculateAndDisplayOverallRank(currentUserId) {
        const rankEl = document.getElementById('dashboardRank');
        try {
            const thirtyDaysAgo = new Date().getTime() - (30 * 24 * 60 * 60 * 1000);
            const snapshot = await database.ref('attempts').orderByChild('timestamp').startAt(thirtyDaysAgo).once('value');
            const allAttemptsLast30Days = snapshot.val() ? Object.values(snapshot.val()) : [];

            const usersData = {};
            allAttemptsLast30Days.forEach(attempt => {
                if(!attempt.stats) return;
                if (!usersData[attempt.userId]) {
                    usersData[attempt.userId] = { accuracySum: 0, count: 0 };
                }
                usersData[attempt.userId].accuracySum += attempt.stats.accuracy;
                usersData[attempt.userId].count++;
            });

            const rankedUsers = Object.entries(usersData).map(([userId, data]) => ({
                userId,
                avgAccuracy: data.accuracySum / data.count,
            }));

            rankedUsers.sort((a, b) => b.avgAccuracy - a.avgAccuracy);

            const userRank = rankedUsers.findIndex(user => user.userId === currentUserId) + 1;
            
            rankEl.textContent = userRank > 0 ? `#${userRank}` : 'N/A';

        } catch (error) {
            console.error("Error calculating rank:", error);
            rankEl.textContent = 'Error';
        }
    }


    function displayCommonMistakes(attempts) { const wordCounts = {}; attempts.slice(0, 20).forEach(attempt => { if (attempt.comparisonHtml) { const tempDiv = document.createElement('div'); tempDiv.innerHTML = attempt.comparisonHtml; tempDiv.querySelectorAll('.missing, .addition, .punctuation, .capitalization').forEach(el => { const word = el.textContent.toLowerCase().replace(/[.,!?;:]/g, '').trim(); if (word) { wordCounts[word] = (wordCounts[word] || 0) + 1; } }); } }); const sortedWords = Object.entries(wordCounts).sort((a, b) => b[1] - a[1]); const listEl = document.getElementById('commonMistakesList'); if (!listEl) return; if (sortedWords.length === 0) { listEl.innerHTML = '<li>No recurring mistakes found.</li>'; return; } listEl.innerHTML = sortedWords.slice(0, 5).map(([word, count]) => `<li><strong>${word}</strong> (missed ${count} times)</li>`).join(''); }
    function displayCategoryPerformance(attempts) { const categoryData = {}; attempts.forEach(att => { const cat = getCategoryDisplayName(att.category); if (!categoryData[cat]) categoryData[cat] = { accuracySum: 0, wpmSum: 0, count: 0 }; categoryData[cat].accuracySum += att.stats.accuracy; categoryData[cat].wpmSum += att.stats.wpm; categoryData[cat].count++; }); const perfEl = document.getElementById('categoryPerformance'); if (!perfEl) return; let tableHTML = `<table class="w-full text-sm text-left"><thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr><th class="px-6 py-3">Category</th><th class="px-6 py-3">Avg. Acc %</th><th class="px-6 py-3">Avg. WPM</th><th class="px-6 py-3">Attempts</th></tr></thead><tbody>`; for (const catName in categoryData) { const data = categoryData[catName]; tableHTML += `<tr class="bg-white border-b"><td class="px-6 py-4 font-medium">${catName}</td><td class="px-6 py-4">${(data.accuracySum / data.count).toFixed(1)}%</td><td class="px-6 py-4">${Math.round(data.wpmSum / data.count)}</td><td class="px-6 py-4">${data.count}</td></tr>`; } tableHTML += '</tbody></table>'; perfEl.innerHTML = tableHTML; }
    
    function renderProgressChart(attempts) {
        if (progressChartInstance) progressChartInstance.destroy();
        const chartCanvas = document.getElementById('progressChart');
        if (!chartCanvas || !window.Chart) return;

        const labels = attempts.map(a => formatDate(a.timestamp));
        const accData = attempts.map(a => a.stats.accuracy);
        
        const gridColor = 'rgba(0, 0, 0, 0.05)';
        const textColor = '#1f2937';

        progressChartInstance = new Chart(chartCanvas, {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: 'Accuracy (%)',
                    data: accData,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    yAxisID: 'yAcc',
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        ticks: { color: textColor },
                        grid: { color: gridColor }
                    },
                    yAcc: {
                        position: 'left',
                        title: { display: true, text: 'Accuracy (%)', color: textColor },
                        min: 0,
                        max: 100,
                        ticks: { color: textColor },
                        grid: { color: gridColor }
                    }
                },
                plugins: {
                    legend: {
                        labels: { color: textColor }
                    }
                }
            }
        });
    }

    function prepareAdminFormForAdd() { renderAdminForm(); }
    function prepareAdminFormForEdit(testId) {
        const testData = allFetchedTests.find(t => t.id === testId);
        if (!testData) { showToast('Error: Could not find test data.', 'error'); return; }
        renderAdminForm();
        const editingIdEl = document.getElementById('adminSection');
        if (editingIdEl) editingIdEl.dataset.editingId = testId;
        document.getElementById('adminPanelTitle').textContent = 'Admin Panel - Edit Test';
        document.getElementById('saveTestBtn').innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Update Test';
        document.getElementById('addTestTitle').value = testData.title;
        document.getElementById('addTestCategory').value = testData.category;
        document.getElementById('addTestText').value = testData.text;
        document.getElementById('addTestVideoUrl').value = testData.videoUrl || '';
        document.getElementById('addTestSolutionVideoUrl').value = testData.solutionVideoUrl || '';
        const currentSolutionAudioEl = document.getElementById('currentSolutionAudio');
        if (testData.solutionAudio && testData.solutionAudio.fileName) { currentSolutionAudioEl.textContent = `Current File: ${testData.solutionAudio.fileName}`; } else { currentSolutionAudioEl.textContent = ''; }
        const currentDictationAudioEl = document.getElementById('currentDictationAudio');
        if (testData.dictationAudio && testData.dictationAudio.fileName) { currentDictationAudioEl.textContent = `Current File: ${testData.dictationAudio.fileName}`; } else { currentDictationAudioEl.textContent = ''; }
        showView('admin');
    }

    function renderAdminForm() {
        adminSection.innerHTML = `<div class="card rounded-lg shadow-lg p-4 sm:p-6" data-editing-id=""><div class="flex justify-between items-center mb-6"><h2 id="adminPanelTitle" class="text-xl sm:text-2xl font-bold">Admin Panel</h2><button id="backToMainFromAdminBtn" class="btn btn-secondary px-4 py-2 rounded-md">Back</button></div><div class="space-y-4"><div><label for="addTestTitle" class="block text-sm font-medium text-gray-700">Test Title</label><input type="text" id="addTestTitle" placeholder="e.g., General Matter No. 1" class="mt-1 w-full p-3 rounded-md input-field"></div><div><label for="addTestCategory" class="block text-sm font-medium text-gray-700">Category</label><select id="addTestCategory" class="mt-1 w-full p-3 rounded-md input-field"><option value="general">General Matter</option> <option value="kailash">Kailash Chandra</option><option value="progressive">Progressive</option> <option value="legal">Legal</option><option value="previous">Previous Year</option> <option value="test">Test</option></select></div><div><label for="addTestText" class="block text-sm font-medium text-gray-700">Test Text</label><textarea id="addTestText" placeholder="Paste the full text of the test here..." rows="10" class="mt-1 w-full p-3 rounded-md input-field"></textarea></div><div><label for="addTestVideoUrl" class="block text-sm font-medium text-gray-700">YouTube Video URL (Optional)</label><input type="url" id="addTestVideoUrl" placeholder="https://www.youtube.com/watch?v=..." class="mt-1 w-full p-3 rounded-md input-field"></div><div><label for="addTestDictationAudio" class="block text-sm font-medium text-gray-700">Dictation Audio (MP3/WAV, Optional)</label><input type="file" id="addTestDictationAudio" accept="audio/*" class="mt-1 w-full p-2 text-sm rounded-md border border-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"><span id="currentDictationAudio" class="text-xs text-gray-500 mt-1 block"></span><div id="dictationAudioProgressContainer" class="hidden mt-2"></div></div><div><label for="addTestSolutionAudio" class="block text-sm font-medium text-gray-700">Audio Solution (Optional, MP3/WAV)</label><input type="file" id="addTestSolutionAudio" accept="audio/*" class="mt-1 w-full p-2 text-sm rounded-md border border-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"><span id="currentSolutionAudio" class="text-xs text-gray-500 mt-1 block"></span><div id="solutionAudioProgressContainer" class="hidden mt-2"></div></div>
        <div><label for="addTestSolutionVideoUrl" class="block text-sm font-medium text-gray-700">YouTube Video Solution URL (Optional)</label><input type="url" id="addTestSolutionVideoUrl" placeholder="https://www.youtube.com/watch?v=..." class="mt-1 w-full p-3 rounded-md input-field"></div>
        <button id="saveTestBtn" class="w-full btn btn-primary py-3 rounded-md font-bold text-lg"><i class="fas fa-save mr-2"></i>Save Test</button></div><div class="mt-8 pt-6 border-t border-gray-200"><h3 class="text-lg font-medium text-gray-900 mb-3">Test Pass Management</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end"><div><label for="passCategory" class="block text-sm font-medium text-gray-700">Pass for Category</label><select id="passCategory" class="mt-1 w-full p-2 rounded-md input-field"><option value="general">General Matter</option><option value="kailash">Kailash Chandra</option><option value="progressive">Progressive</option><option value="legal">Legal</option><option value="previous">Previous Year</option><option value="test">Test</option></select></div><div><label for="passValidityDays" class="block text-sm font-medium text-gray-700">Validity (Days)</label><input type="number" id="passValidityDays" value="30" min="1" max="365" class="mt-1 w-full p-2 rounded-md input-field text-center"></div><div class="md:col-span-2 grid grid-cols-2 gap-4"><button id="generatePassBtn" class="w-full btn bg-pink-500 text-white px-4 py-2 rounded-md font-semibold"><i class="fas fa-ticket-alt mr-2"></i>Generate Specific Pass</button><button id="generateAllAccessPassBtn" class="w-full btn bg-purple-600 text-white px-4 py-2 rounded-md font-semibold"><i class="fas fa-globe mr-2"></i>Generate All-Access Pass</button></div><div class="md:col-span-2"><input type="text" id="generatedPassCode" placeholder="Generated code..." readonly class="w-full input-field p-2 bg-gray-200 cursor-text"></div></div></div><div class="mt-8 pt-6 border-t border-gray-200"><h3 class="text-lg font-medium text-gray-900 mb-3">Manage Activation Codes</h3><div id="activationCodeList" class="overflow-x-auto max-h-96"></div></div></div>`;
        document.getElementById('backToMainFromAdminBtn').addEventListener('click', () => showView('main'));
        document.getElementById('saveTestBtn').addEventListener('click', saveOrUpdateTest);
        document.getElementById('generatePassBtn').addEventListener('click', () => generateTestPass(false));
        document.getElementById('generateAllAccessPassBtn').addEventListener('click', () => generateTestPass(true));
        document.getElementById('activationCodeList').addEventListener('click', (e) => {
            const button = e.target.closest('.delete-code-btn');
            if (button) { const codeId = button.dataset.codeId; if (confirm('Are you sure you want to delete this unused activation code?')) { database.ref(`activationCodes/${codeId}`).remove().then(() => { showToast('Code deleted successfully.', 'success'); }).catch(error => { showToast('Error deleting code: ' + error.message, 'error'); }); } }
        });
        loadAndDisplayActivationCodes();
    }
    
    function deleteTest(testId) { if (confirm('Are you sure you want to permanently delete this test?')) { database.ref('tests/' + testId).remove().then(() => { showToast('Test deleted successfully.', 'success'); fetchAndDisplayGlobalTests(); }).catch(error => { showToast('Error deleting test: ' + error.message, 'error'); }); } }
    async function saveOrUpdateTest() {
        const saveBtn = document.getElementById('saveTestBtn');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
        try {
            const title = document.getElementById('addTestTitle').value.trim();
            const category = document.getElementById('addTestCategory').value;
            const text = document.getElementById('addTestText').value.trim();
            const videoUrl = document.getElementById('addTestVideoUrl').value.trim();
            const solutionVideoUrl = document.getElementById('addTestSolutionVideoUrl').value.trim();
            const editingIdEl = document.getElementById('adminSection');
            const editingId = editingIdEl ? editingIdEl.dataset.editingId : '';
            if (!title || !text || !category) { showToast('Please fill in Title, Text, and Category.', 'error'); throw new Error("Missing required fields"); }
            const testData = { title, category, text, videoUrl, solutionVideoUrl, userName: currentUser.displayName || 'Admin', userId: currentUser.uid, timestamp: firebase.database.ServerValue.TIMESTAMP };
            const solutionAudioFile = document.getElementById('addTestSolutionAudio').files[0];
            if (solutionAudioFile) {
                const progressContainer = document.getElementById('solutionAudioProgressContainer');
                progressContainer.innerHTML = '';
                progressContainer.classList.remove('hidden');
                const progressElement = document.createElement('div');
                progressElement.innerHTML = `<label class="text-sm font-medium">${solutionAudioFile.name}</label><div class="progress-bar"><div class="progress-bar-inner"></div></div>`;
                progressContainer.appendChild(progressElement);
                const progressBar = progressElement.querySelector('.progress-bar-inner');
                const progressCallback = (percentage) => { progressBar.style.width = percentage + '%'; };
                const response = await uploadToCloudinary(solutionAudioFile, progressCallback);
                testData.solutionAudio = { url: response.secure_url, fileName: response.original_filename, type: response.resource_type === 'raw' ? solutionAudioFile.type : `${response.resource_type}/${response.format}`, publicId: response.public_id };
            }
            const dictationAudioFile = document.getElementById('addTestDictationAudio').files[0];
            if (dictationAudioFile) {
                const progressContainer = document.getElementById('dictationAudioProgressContainer');
                progressContainer.innerHTML = '';
                progressContainer.classList.remove('hidden');
                const progressElement = document.createElement('div');
                progressElement.innerHTML = `<label class="text-sm font-medium">${dictationAudioFile.name}</label><div class="progress-bar"><div class="progress-bar-inner"></div></div>`;
                progressContainer.appendChild(progressElement);
                const progressBar = progressElement.querySelector('.progress-bar-inner');
                const progressCallback = (percentage) => { progressBar.style.width = percentage + '%'; };
                const response = await uploadToCloudinary(dictationAudioFile, progressCallback);
                testData.dictationAudio = { url: response.secure_url, fileName: response.original_filename, type: response.resource_type === 'raw' ? dictationAudioFile.type : `${response.resource_type}/${response.format}`, publicId: response.public_id };
            }
            const promise = editingId ? database.ref('tests/' + editingId).update(testData) : database.ref('tests').push(testData);
            await promise;
            showToast(editingId ? 'Test updated successfully!' : 'Test added successfully!', 'success');
            showView('main');
            fetchAndDisplayGlobalTests();
        } catch (error) { console.error('Error saving test:', error); showToast(`Error saving the test: ${error.message}`, 'error'); } 
        finally { saveBtn.disabled = false; saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save Test'; }
    }

    function generateTestPass(isAllAccess = false) {
        const category = isAllAccess ? 'all' : document.getElementById('passCategory').value;
        if(!category) { showToast("Please select a category for the pass.", "error"); return; }

        let validityDays = parseInt(document.getElementById('passValidityDays').value, 10);
        if (isNaN(validityDays) || validityDays < 1 || validityDays > 365) {
            showToast("Invalid number of days. Using default of 30.", "warning");
            validityDays = 30;
            document.getElementById('passValidityDays').value = 30;
        }

        const planName = isAllAccess 
            ? `All-Access Pass - ${validityDays} Day Pass`
            : `${getCategoryDisplayName(category)} - ${validityDays} Day Pass`;
        
        const codePrefix = isAllAccess ? 'ALL' : category.substring(0, 3).toUpperCase();
        const code = `SW-${codePrefix}-${Math.random().toString(36).substring(2, 6).toUpperCase()}`;
        
        const passData = {
            code,
            category: category, // This will be 'all' for the combined pass
            createdAt: firebase.database.ServerValue.TIMESTAMP,
            expiresAt: new Date(new Date().setDate(new Date().getDate() + validityDays)).getTime(),
            isUsed: false,
            usedBy: null,
            usedOn: null,
            usedByName: null,
            planName: planName,
            totalDays: validityDays
        };

        database.ref('activationCodes').push(passData)
            .then(() => {
                document.getElementById('generatedPassCode').value = code;
                showToast(`Pass generated for ${isAllAccess ? 'All Categories' : getCategoryDisplayName(category)}: ${code}`, 'success');
            })
            .catch(error => showToast('Error generating pass: ' + error.message, 'error'));
    }

    function loadAndDisplayActivationCodes() { const listEl = document.getElementById('activationCodeList'); if (!listEl) return; const codesRef = database.ref('activationCodes').orderByChild('createdAt'); codesRef.on('value', snapshot => { listEl.innerHTML = '<p class="p-4 text-center">Loading codes...</p>'; const codes = snapshot.val(); if (!codes) { listEl.innerHTML = '<p class="p-4 text-center text-gray-500">No activation codes found.</p>'; return; } const tableHTML = Object.entries(codes).reverse().map(([key, codeData]) => { const expires = formatDate(codeData.expiresAt); const status = codeData.isUsed ? `<span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">Used</span>` : `<span class="bg-green-100 text-green-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">Active</span>`; const usedBy = codeData.usedByName || 'N/A'; const actionButton = codeData.isUsed ? `` : `<button class="delete-code-btn btn bg-red-500 text-white p-1 rounded-md text-xs" data-code-id="${key}"><i class="fas fa-trash-alt"></i></button>`; const categoryDisplay = getCategoryDisplayName(codeData.category || 'general'); return `<tr class="bg-white border-b hover:bg-gray-50"><td class="px-6 py-4 font-mono">${codeData.code}</td><td class="px-6 py-4">${categoryDisplay}</td><td class="px-6 py-4">${expires}</td><td class="px-6 py-4">${status}</td><td class="px-6 py-4">${usedBy}</td><td class="px-6 py-4">${actionButton}</td></tr>`; }).join(''); listEl.innerHTML = `<div class="overflow-x-auto border border-gray-200 rounded-lg"><table class="w-full text-sm text-left"><thead class="text-xs text-white uppercase bg-slate-700"><tr><th scope="col" class="px-6 py-3">Code</th><th scope="col" class="px-6 py-3">Category</th><th scope="col" class="px-6 py-3">Expires</th><th scope="col" class="px-6 py-3">Status</th><th scope="col" class="px-6 py-3">Used By</th><th scope="col" class="px-6 py-3">Actions</th></tr></thead><tbody>${tableHTML}</tbody></table></div>`; }); }
    
    // --- START: NEW DUAL-VIEW LEADERBOARD IMPLEMENTATION ---

    let allAdminAttempts = [];
    let filteredAdminAttempts = [];
    let adminLeaderboardCurrentPage = 1;
    const adminLeaderboardPerPage = 15;
    let adminLeaderboardSort = { key: 'timestamp', order: 'desc' };

    function loadLeaderboardData() {
        showUserLeaderboardView(); // All users start at the public-facing view
    }

    function showUserLeaderboardView() {
        const isAdmin = currentUser && ADMIN_EMAILS.includes(currentUser.email);
        leaderboardSection.innerHTML = `
        <div class="bg-white rounded-lg shadow-lg">
            <div class="p-4 sm:p-6 flex flex-col sm:flex-row justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-800">Top 100 Performers this week!</h2>
                 ${isAdmin 
                    ? `<button id="adminViewBtn" class="btn bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-md mt-4 sm:mt-0 font-semibold text-sm">Admin View</button>`
                    : `<button id="backToMainFromLeaderboardBtn" class="btn btn-secondary px-4 py-2 rounded-md mt-4 sm:mt-0">Back</button>`
                }
            </div>
            <div id="userLeaderboardContent" class="overflow-x-auto">
                <div class="text-center p-8"><i class="fas fa-spinner fa-spin text-2xl text-indigo-500"></i><p class="mt-2 text-gray-600">Loading leaderboard...</p></div>
            </div>
        </div>`;

        if (isAdmin) {
            document.getElementById('adminViewBtn').addEventListener('click', showAdminLeaderboardView);
        } else {
            document.getElementById('backToMainFromLeaderboardBtn').addEventListener('click', () => showView('main'));
        }
        
        database.ref('attempts').once('value').then(snapshot => {
            const allAttempts = snapshot.exists() ? Object.entries(snapshot.val()).map(([id, value]) => ({...value, id })) : [];
            renderUserLeaderboardTable(allAttempts);
        }).catch(error => {
            console.error('Error fetching leaderboard data:', error);
            document.getElementById('userLeaderboardContent').innerHTML = `<p class="text-center p-8 text-red-500">Error loading data.</p>`;
        });
    }

    function renderUserLeaderboardTable(attempts) {
        const contentEl = document.getElementById('userLeaderboardContent');
        
        const filteredAttempts = attempts.filter(a => a.stats && a.stats.accuracy !== undefined);
        
        filteredAttempts.sort((a, b) => {
            if (b.stats.accuracy !== a.stats.accuracy) return b.stats.accuracy - a.stats.accuracy;
            return b.timestamp - a.timestamp; 
        });

        const top100 = filteredAttempts.slice(0, 100);

        if (top100.length === 0) {
            contentEl.innerHTML = `<p class="text-center p-8 text-gray-500">No leaderboard data available yet. Be the first to set a record!</p>`;
            return;
        }

        const tableRows = top100.map((attempt, index) => {
            const rank = index + 1;
            const photo = attempt.userPhoto || `https://www.gravatar.com/avatar/${attempt.userId}?d=identicon&s=32`;
            const name = attempt.userName || 'Anonymous';
            const dictationName = attempt.testTitle;
            const accuracy = `${attempt.stats.accuracy.toFixed(2)}%`;
            const speed = attempt.dictationSpeed === 'original' ? 'Original' : `${attempt.dictationSpeed} WPM`;
            
            return `
                <tr class="border-b">
                    <td class="px-4 py-4 font-bold text-gray-700 text-center">${rank}</td>
                    <td class="px-4 py-4 text-center"><img src="${photo}" class="w-8 h-8 rounded-full object-cover inline-block" alt="${name}"></td>
                    <td class="px-4 py-4 font-medium text-gray-800">${name}</td>
                    <td class="px-4 py-4 text-gray-600">${dictationName}</td>
                    <td class="px-4 py-4 font-semibold text-green-600">${accuracy}</td>
                    <td class="px-4 py-4 font-semibold text-indigo-600">${speed}</td>
                </tr>`;
        }).join('');

        contentEl.innerHTML = `
            <table class="w-full text-left text-sm">
                <thead class="bg-gray-800 text-white uppercase text-xs tracking-wider">
                    <tr>
                        <th scope="col" class="px-4 py-3 text-center">Rank</th>
                        <th scope="col" class="px-4 py-3 text-center">Profile</th>
                        <th scope="col" class="px-4 py-3"><i class="fas fa-user mr-2 opacity-70"></i>Name</th>
                        <th scope="col" class="px-4 py-3"><i class="fas fa-file-alt mr-2 opacity-70"></i>Dictation Name</th>
                        <th scope="col" class="px-4 py-3"><i class="fas fa-bullseye mr-2 opacity-70"></i>Accuracy</th>
                        <th scope="col" class="px-4 py-3"><i class="fas fa-tachometer-alt mr-2 opacity-70"></i>Speed</th>
                    </tr>
                </thead>
                <tbody class="bg-white">${tableRows}</tbody>
            </table>`;
    }

    function showAdminLeaderboardView() {
        leaderboardSection.innerHTML = `
        <div class="bg-white rounded-lg shadow-lg">
            <div class="p-4 sm:p-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                <h2 class="text-2xl font-bold text-gray-800">Leaderboard (Admin Panel)</h2>
                <div class="flex items-center gap-2">
                    <button id="userViewBtn" class="btn bg-purple-500 text-white hover:bg-purple-600 px-4 py-2 rounded-md font-semibold text-sm">View User Leaderboard</button>
                    <button id="backToMainFromAdminLeaderboard" class="btn bg-gray-600 text-white hover:bg-gray-700 px-4 py-2 rounded-md font-semibold text-sm">Back</button>
                </div>
            </div>
            
            <div class="p-4 border-t border-b bg-gray-50 flex flex-col sm:flex-row items-center gap-4">
                <select id="leaderboardCategoryFilter" class="input-field p-2 rounded-md w-full sm:w-auto">
                    <option value="all">All</option>
                    <option value="general">General</option>
                    <option value="kailash">Kailash</option>
                    <option value="progressive">Progressive</option>
                    <option value="legal">Legal</option>
                    <option value="previous">Previous Year</option>
                </select>
                <input type="search" id="leaderboardSearchInput" placeholder="Search User or Test..." class="input-field p-2 rounded-md flex-grow">
                <button id="deleteSelectedAttemptsBtn" class="btn bg-pink-500 text-white hover:bg-pink-600 px-4 py-2 rounded-md font-semibold text-sm w-full sm:w-auto" disabled>Delete Selected</button>
            </div>

            <div id="adminLeaderboardContent" class="overflow-x-auto">
                 <div class="text-center p-8"><i class="fas fa-spinner fa-spin text-2xl text-indigo-500"></i><p class="mt-2 text-gray-600">Loading data...</p></div>
            </div>
            <div id="adminLeaderboardPagination" class="p-4 border-t flex justify-center items-center gap-2"></div>
        </div>`;

        document.getElementById('userViewBtn').addEventListener('click', showUserLeaderboardView);
        document.getElementById('backToMainFromAdminLeaderboard').addEventListener('click', () => showView('main'));
        
        fetchAndDisplayAdminData();
    }

    function fetchAndDisplayAdminData() {
        if (allAdminAttempts.length > 0) {
            displayAdminLeaderboard(); // Use cached data if available
            return;
        }
        database.ref('attempts').once('value').then(snapshot => {
            allAdminAttempts = snapshot.exists() ? Object.entries(snapshot.val()).map(([id, value]) => ({ ...value, id })) : [];
            displayAdminLeaderboard();
        }).catch(error => {
            console.error('Error fetching admin leaderboard data:', error);
            document.getElementById('adminLeaderboardContent').innerHTML = `<p class="text-center p-8 text-red-500">Error loading data.</p>`;
        });
    }

    function displayAdminLeaderboard() {
        const category = document.getElementById('leaderboardCategoryFilter')?.value || 'all';
        const searchTerm = document.getElementById('leaderboardSearchInput')?.value.toLowerCase() || '';

        // Filter
        filteredAdminAttempts = allAdminAttempts.filter(att => {
            if (!att.stats) return false;
            const categoryMatch = category === 'all' || att.category === category;
            const searchMatch = !searchTerm || att.userName?.toLowerCase().includes(searchTerm) || att.testTitle?.toLowerCase().includes(searchTerm);
            return categoryMatch && searchMatch;
        });

        // Sort
        const { key, order } = adminLeaderboardSort;
        filteredAdminAttempts.sort((a, b) => {
            const valA = key.startsWith('stats.') ? a.stats[key.split('.')[1]] : a[key];
            const valB = key.startsWith('stats.') ? b.stats[key.split('.')[1]] : b[key];
            if (valA < valB) return order === 'asc' ? -1 : 1;
            if (valA > valB) return order === 'asc' ? 1 : -1;
            return 0;
        });
        
        renderAdminTableAndPagination();
    }
    
    function renderAdminTableAndPagination() {
        const contentEl = document.getElementById('adminLeaderboardContent');
        const paginationEl = document.getElementById('adminLeaderboardPagination');
        
        const start = (adminLeaderboardCurrentPage - 1) * adminLeaderboardPerPage;
        const end = start + adminLeaderboardPerPage;
        const pageItems = filteredAdminAttempts.slice(start, end);

        if (pageItems.length === 0) {
            contentEl.innerHTML = `<p class="text-center p-8 text-gray-500">No results found for the current filter.</p>`;
            paginationEl.innerHTML = '';
            return;
        }

        const tableRows = pageItems.map((att, index) => {
            const rank = start + index + 1;
            const photo = att.userPhoto || `https://www.gravatar.com/avatar/${att.userId}?d=identicon&s=32`;
            const trophy = att.isFirstAttempt ? '<i class="fas fa-trophy text-yellow-500 ml-1" title="First Attempt!"></i>' : '';
            return `
            <tr class="border-b text-sm">
                <td class="p-3 text-center"><input type="checkbox" class="admin-leaderboard-checkbox" data-id="${att.id}"></td>
                <td class="p-3 font-semibold text-center">${rank} ${trophy}</td>
                <td class="p-3 flex items-center gap-2"><img src="${photo}" class="w-8 h-8 rounded-full object-cover"><span class="font-medium">${att.userName}</span></td>
                <td class="p-3">${att.testTitle} <span class="ml-2 text-xs font-semibold text-white bg-blue-500 px-2 py-0.5 rounded-full">${getCategoryDisplayName(att.category)}</span></td>
                <td class="p-3 font-bold text-orange-600">${att.stats.accuracy.toFixed(1)}%</td>
                <td class="p-3">${att.stats.wpm}</td>
                <td class="p-3 font-bold text-red-500">${att.stats.totalMistakes}</td>
                <td class="p-3 text-gray-500">${new Date(att.timestamp).toLocaleDateString('en-GB')}</td>
            </tr>`;
        }).join('');

        const sortIcon = (key) => {
            if (adminLeaderboardSort.key !== key) return '<i class="fas fa-sort opacity-30"></i>';
            return adminLeaderboardSort.order === 'asc' ? '<i class="fas fa-sort-up"></i>' : '<i class="fas fa-sort-down"></i>';
        };
        
        contentEl.innerHTML = `
        <table class="w-full">
            <thead class="bg-blue-600 text-white text-xs uppercase">
                <tr>
                    <th class="p-3 text-center"><input type="checkbox" id="selectAllAdminCheckboxes"></th>
                    <th class="p-3 sortable-header" data-key="rank"># ${sortIcon('rank')}</th>
                    <th class="p-3 sortable-header" data-key="userName">User ${sortIcon('userName')}</th>
                    <th class="p-3 sortable-header" data-key="testTitle">Test ${sortIcon('testTitle')}</th>
                    <th class="p-3 sortable-header" data-key="stats.accuracy">Acc % ${sortIcon('stats.accuracy')}</th>
                    <th class="p-3 sortable-header" data-key="stats.wpm">WPM ${sortIcon('stats.wpm')}</th>
                    <th class="p-3 sortable-header" data-key="stats.totalMistakes">Mistakes ${sortIcon('stats.totalMistakes')}</th>
                    <th class="p-3 sortable-header" data-key="timestamp">Date ${sortIcon('timestamp')}</th>
                </tr>
            </thead>
            <tbody id="adminLeaderboardTableBody">${tableRows}</tbody>
        </table>`;
        
        // Pagination logic
        const totalPages = Math.ceil(filteredAdminAttempts.length / adminLeaderboardPerPage);
        paginationEl.innerHTML = `
            <button id="prevPageBtn" class="btn p-2" ${adminLeaderboardCurrentPage === 1 ? 'disabled' : ''}><i class="fas fa-chevron-left"></i></button>
            <span>Page ${adminLeaderboardCurrentPage} of ${totalPages}</span>
            <button id="nextPageBtn" class="btn p-2" ${adminLeaderboardCurrentPage === totalPages ? 'disabled' : ''}><i class="fas fa-chevron-right"></i></button>
        `;
        
        // Attach event listeners after rendering
        addAdminLeaderboardEventListeners();
    }
    
    function addAdminLeaderboardEventListeners() {
        // Sorting
        document.querySelectorAll('.sortable-header').forEach(header => {
            header.addEventListener('click', () => {
                const key = header.dataset.key;
                if (adminLeaderboardSort.key === key) {
                    adminLeaderboardSort.order = adminLeaderboardSort.order === 'asc' ? 'desc' : 'asc';
                } else {
                    adminLeaderboardSort.key = key;
                    adminLeaderboardSort.order = 'desc';
                }
                adminLeaderboardCurrentPage = 1;
                displayAdminLeaderboard();
            });
        });

        // Filters
        document.getElementById('leaderboardCategoryFilter')?.addEventListener('change', () => { adminLeaderboardCurrentPage = 1; displayAdminLeaderboard(); });
        document.getElementById('leaderboardSearchInput')?.addEventListener('input', () => { adminLeaderboardCurrentPage = 1; displayAdminLeaderboard(); });

        // Pagination
        document.getElementById('prevPageBtn')?.addEventListener('click', () => { if (adminLeaderboardCurrentPage > 1) { adminLeaderboardCurrentPage--; renderAdminTableAndPagination(); } });
        document.getElementById('nextPageBtn')?.addEventListener('click', () => { const totalPages = Math.ceil(filteredAdminAttempts.length / adminLeaderboardPerPage); if (adminLeaderboardCurrentPage < totalPages) { adminLeaderboardCurrentPage++; renderAdminTableAndPagination(); } });

        // Checkboxes
        const deleteBtn = document.getElementById('deleteSelectedAttemptsBtn');
        const allCheckboxes = document.querySelectorAll('.admin-leaderboard-checkbox');
        const selectAllCheckbox = document.getElementById('selectAllAdminCheckboxes');

        function toggleDeleteButton() {
            const anyChecked = Array.from(allCheckboxes).some(cb => cb.checked);
            deleteBtn.disabled = !anyChecked;
        }

        allCheckboxes.forEach(cb => cb.addEventListener('change', toggleDeleteButton));
        selectAllCheckbox.addEventListener('change', () => {
            allCheckboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
            toggleDeleteButton();
        });

        // Deletion
        deleteBtn.addEventListener('click', () => {
            const selectedIds = Array.from(allCheckboxes).filter(cb => cb.checked).map(cb => cb.dataset.id);
            if (selectedIds.length === 0) return;
            if (confirm(`Are you sure you want to delete ${selectedIds.length} selected attempt(s)?`)) {
                const updates = {};
                selectedIds.forEach(id => { updates[`/attempts/${id}`] = null; });
                database.ref().update(updates).then(() => {
                    showToast(`${selectedIds.length} attempt(s) deleted successfully.`, 'success');
                    // Refetch data
                    allAdminAttempts = []; 
                    fetchAndDisplayAdminData();
                }).catch(err => showToast(`Error deleting attempts: ${err.message}`, 'error'));
            }
        });
    }

    // --- END: NEW DUAL-VIEW LEADERBOARD IMPLEMENTATION ---
    
    function renderExamInterface(originalText, userText) {
        showView('exam');
        document.getElementById('sidebar').style.display = 'none'; // Hide sidebar for exam mode
        examInterface.innerHTML = `<div class="max-w-7xl mx-auto"><div class="flex justify-between items-center bg-white p-3 rounded-t-lg shadow"><div class="flex items-center space-x-3"><img src="https://i.ibb.co/Kz80Fq8C/SSClogo759.webp" alt="SSC Logo" class="h-10"><div><h1 class="font-bold text-lg text-gray-800">Staff Selection Commission</h1><p class="text-sm text-gray-600">${currentTestDetails.title}</p></div></div><div class="text-right text-xs"><p><strong>Exam Date:</strong> <span>${new Date().toLocaleDateString('en-GB')}</span></p><p><strong>Shift:</strong> 3rd Shift (Evening)</p></div></div><div class="flex flex-col lg:flex-row gap-6 mt-1 bg-white p-6 rounded-b-lg shadow"><div class="flex-grow"><textarea id="examUserText" placeholder="Start typing..." spellcheck="false" autocorrect="off" class="w-full p-4 rounded-md border border-gray-300 h-96 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea><button id="examSubmitBtn" class="mt-4 btn bg-blue-600 text-white px-8 py-2 rounded-md font-semibold hover:bg-blue-700">Submit</button><textarea id="examOriginalTextHolder" class="hidden"></textarea></div><div class="w-full lg:w-72 flex-shrink-0"><div class="border rounded-lg p-4"><div id="examTimerDisplay" class="text-center text-2xl font-bold text-gray-800 mb-4 p-2 border-b">Time Left: 00:00</div><div class="flex flex-col items-center"><img id="examUserPhoto" class="w-24 h-24 rounded-full object-cover mb-4"><div class="text-sm space-y-2 w-full"><p><strong>Name:</strong> <span id="examUserName"></span></p><p><strong>Roll No:</strong> <span id="examUserRollNo"></span></p><p><strong>Language:</strong> English</p></div></div></div></div></div></div>`; const examUserTextEl = document.getElementById('examUserText'); const examOriginalTextHolderEl = document.getElementById('examOriginalTextHolder'); document.getElementById('examSubmitBtn').addEventListener('click', triggerComparisonFromExam); examOriginalTextHolderEl.value = originalText; examUserTextEl.value = userText; examUserTextEl.readOnly = false; examUserTextEl.focus(); document.getElementById('examUserPhoto').src = currentUser.photoURL || `https://www.gravatar.com/avatar/${currentUser.uid}?d=identicon&s=96`; document.getElementById('examUserName').textContent = currentUser.displayName || 'User'; document.getElementById('examUserRollNo').textContent = currentUser.uid.substring(0, 12).toUpperCase(); document.querySelector('header').classList.add('hidden'); document.querySelector('footer').classList.add('hidden'); enterFullscreen(document.documentElement); }
});

var player;
var audioPlayer;
var videoPlayerInterval;
var solutionPlayer;
var solutionPlayerInterval;
var fluctuationInterval; // For speed fluctuation

function onYouTubeIframeAPIReady() {}

function applyPlaybackSpeed() {
    const dictationSpeedWPMEl = document.getElementById('dictationSpeedWPM');
    const originalTextEl = document.getElementById('originalText');
    const fluctuationEl = document.getElementById('fluctuation